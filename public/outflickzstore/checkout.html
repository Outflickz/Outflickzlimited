<!DOCTYPE html>
<html lang="en" class="text-[90%] sm:text-[95%] md:text-[100%]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Outflickz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script> 
    <style>
        /* Load Inter (main font) and Playfair Display (for "OUTFLICKZ" logo) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');

        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hide number input arrows/spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Custom styles for the message modal */
        #message-modal-container {
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
        }
        #message-modal-container.hidden .modal-content {
            transform: translateY(-50px);
        }
        
        /* Step indicator styling */
        .step-active {
            @apply bg-ash-red text-white;
        }
        .step-inactive {
            @apply bg-gray-200 text-gray-500;
        }
        .step-complete {
            @apply bg-green-500 text-white;
        }
    </style>
</head>
<body class="bg-gray-50 text-color-black min-h-screen">

    <div id="message-modal-container" class="fixed inset-0 z-[100] hidden flex justify-center items-start pt-10" role="alert" aria-live="assertive">
        <div class="modal-content bg-ash-dark text-white p-4 rounded-lg shadow-2xl max-w-sm w-full relative">
            <p id="message-modal-text" class="text-sm font-medium"></p>
            <button id="message-modal-close-btn" class="absolute top-1 right-1 text-gray-400 hover:text-white transition" aria-label="Close message">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <header class="bg-color-white sticky top-0 z-50 shadow-md border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 sm:h-16 flex items-center justify-between">
            <a href="homepage.html" class="flex items-center" aria-label="Outflickz Home">
                <img src="https://i.imgur.com/PZLMws6.jpeg" alt="Outflickz Logo" class="w-auto h-10 sm:h-12 lg:h-10">
            </a>

            <nav class="hidden md:flex flex-grow justify-center space-x-6 lg:space-x-10 text-sm" aria-label="Main Navigation">
                <a href="homepage.html" class="font-medium text-color-black hover:text-gray-600 transition">Homepage</a>
                <a href="preorder.html" class="font-medium text-color-black hover:text-gray-600 transition">Pre Order</a>
                <a href="newarrivals.html" class="font-medium text-color-black hover:text-gray-600 transition">New Arrivals</a>
                <a href="wearscollection.html" class="font-medium text-color-black hover:text-gray-600 transition flex items-center">Wears Collections</a>
                <a href="capcollection.html" class="font-medium text-color-black hover:text-gray-600 transition flex items-center">Cap Collections</a>
            </nav>

            <div class="flex items-center space-x-2 sm:space-x-4">
                <button id="profile-icon" 
                class="p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full hidden md:block" 
                aria-label="User Account"
                onclick="redirectToProfileOrLogin()">
                    <i class="fas fa-user w-4 h-4 sm:w-5 sm:h-5"></i>
                </button>
                <a href="cart.html" class="relative p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full" aria-label="Shopping Bag">
                    <i class="fas fa-shopping-bag w-4 h-4 sm:w-5 sm:h-5"></i>
                    <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-ash-red rounded-full hidden">
                        0
                    </span>
                </a>
                <button class="md:hidden p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full" onclick="toggleMenu()" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open main menu">
                    <i class="fas fa-bars w-5 h-5 sm:w-6 sm:h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="mobile-menu" class="hidden md:hidden bg-color-white border-b border-gray-100 absolute w-full z-40 shadow-lg">
        <div class="px-2 pt-2 pb-3 space-y-1 text-sm">
            <a href="homepage.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Homepage</a>
            <a href="preorder.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Pre Order</a>
            <a href="newarrivals.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">New Arrivals</a>
            <a href="wearscollection.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Wears Collection</a>
            <a href="capcollection.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Cap Collection</a>
            <a href="javascript:void(0);" onclick="redirectToProfileOrLogin()" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Account</a>
        </div>
    </div>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-12">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-ash-dark mb-8 uppercase tracking-wide">
            ðŸ’³ Secure Checkout
        </h1>

        <div class="flex justify-between items-center mb-10 text-center relative">
            <div class="absolute inset-x-0 top-3 h-0.5 bg-gray-200 z-0"></div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-1" class="step-indicator step-active w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">1</div>
                <span class="text-xs sm:text-sm text-ash-dark font-medium">Shipping Info</span>
            </div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-2" class="step-indicator step-inactive w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">2</div>
                <span class="text-xs sm:text-sm text-gray-500">Review Order</span>
            </div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-3" class="step-indicator step-inactive w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">3</div>
                <span class="text-xs sm:text-sm text-gray-500">Payment</span>
            </div>
        </div> 
        
        <div class="lg:grid lg:grid-cols-3 lg:gap-10">
            
            <div class="lg:col-span-2 space-y-8">
                
                <section id="shipping-info-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">1. Contact & Shipping Information</h2>
                    <form id="shipping-form" onsubmit="event.preventDefault(); validateAndProceedToReview();">
                        <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-6">
                            <div class="sm:col-span-2">
                                <label for="email" class="block text-sm font-medium text-gray-700">Email address (for confirmations) <span class="text-ash-red">*</span></label>
                                <input type="email" id="email" name="email" autocomplete="email" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red" placeholder="e.g., john.doe@example.com">
                            </div>
                            <div class="sm:col-span-2 border-t border-gray-200 pt-6 mt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Shipping Details</h3>
                            </div>

                            <div>
                                <label for="first-name" class="block text-sm font-medium text-gray-700">First name <span class="text-ash-red">*</span></label>
                                <input type="text" id="first-name" name="first-name" autocomplete="given-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="last-name" class="block text-sm font-medium text-gray-700">Last name <span class="text-ash-red">*</span></label>
                                <input type="text" id="last-name" name="last-name" autocomplete="family-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div class="sm:col-span-2">
                                <label for="address-line-1" class="block text-sm font-medium text-gray-700">Street address <span class="text-ash-red">*</span></label>
                                <input type="text" id="address-line-1" name="address-line-1" autocomplete="street-address" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium text-gray-700">City <span class="text-ash-red">*</span></label>
                                <input type="text" id="city" name="city" autocomplete="address-level2" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-gray-700">State / Province <span class="text-ash-red">*</span></label>
                                <input type="text" id="state" name="state" autocomplete="address-level1" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="zip-code" class="block text-sm font-medium text-gray-700">ZIP / Postal code <span class="text-ash-red">*</span></label>
                                <input type="text" id="zip-code" name="zip-code" autocomplete="postal-code" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="country" class="block text-sm font-medium text-gray-700">Country <span class="text-ash-red">*</span></label>
                                <select id="country" name="country" autocomplete="country-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="Ghana">Ghana</option>
                                    </select>
                            </div>
                        </div>
                    </form>
                </section>

                <section id="review-order-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100 hidden">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">2. Review & Confirm</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">Shipping Address</h3>
                                <button onclick="checkoutStep = 1; updateCheckoutView();" class="text-sm font-medium text-ash-red hover:text-red-700">Change</button>
                            </div>
                            <div class="text-sm text-gray-700 p-4 bg-gray-50 rounded-md border">
                                <p id="review-address-name" class="font-medium"></p>
                                <p id="review-address-line1"></p>
                                <p id="review-address-line2"></p>
                                <p id="review-contact-info" class="mt-2 text-gray-500"></p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Items in Order</h3>
                            <div id="review-items-list" class="divide-y divide-gray-100 border border-gray-200 rounded-md p-2">
                                </div>
                        </div>
                    </div>
                </section>

                <section id="payment-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100 hidden">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">3. Payment</h2>
                    
                    <div class="space-y-6">
                        <p class="text-gray-700">Please select your preferred payment method:</p>

                        <div class="space-y-4">
                            <div class="relative flex items-start border border-gray-300 rounded-md p-4 transition-all focus-within:ring-2 focus-within:ring-ash-red">
                                <div class="flex items-center h-5">
                                    <input id="payment-paystack" name="payment-method" type="radio" value="Paystack/Card" checked class="focus:ring-ash-red h-4 w-4 text-ash-red border-gray-300">
                                </div>
                                <div class="ml-3 text-sm flex-1">
                                    <label for="payment-paystack" class="font-medium text-gray-900 flex justify-between items-center">
                                        Card Payment (Paystack)
                                        <img src="https://i.imgur.com/fuT8ucM.png" alt="Paystack" class="h-5">
                                    </label>
                                    <p id="paystack-description" class="text-gray-500">Pay securely with your Visa, MasterCard, or Verve card.</p>
                                </div>
                            </div>

                            <div class="relative flex items-start border border-gray-300 rounded-md p-4 transition-all focus-within:ring-2 focus-within:ring-ash-red">
                                <div class="flex items-center h-5">
                                    <input id="payment-bank" name="payment-method" type="radio" value="Bank Transfer" class="focus:ring-ash-red h-4 w-4 text-ash-red border-gray-300">
                                </div>
                                <div class="ml-3 text-sm flex-1">
                                    <label for="payment-bank" class="font-medium text-gray-900">
                                        Direct Bank Transfer (Manual)
                                    </label>
                                    <p id="bank-description" class="text-gray-500">View details below and complete payment manually.</p>
                                    
                                   <div id="bank-details-info" class="mt-3 p-3 bg-gray-100 rounded-md border border-gray-200" style="display:none;">
    <h4 class="font-bold text-ash-dark mb-1">Outflickz Account Details:</h4>
    <p class="text-xs">
        **Bank Name:** Opay<br>
        **Account Name:** Outflickz limited<br>
        **Account Number:** 8149747864
    </p>
    
    <hr class="my-3 border-gray-300">
    
    <h4 class="font-bold text-ash-dark mb-2">Upload Payment Receipt <span class="text-ash-red">*</span></h4>
    <p class="text-xs text-gray-500 mb-2">Upload a screenshot/proof of payment to proceed with manual verification.</p>
    <input type="file" id="bank-receipt-upload" accept="image/*" class="w-full text-sm text-gray-900 border border-gray-300 rounded-sm cursor-pointer bg-white file:py-2 file:px-4 file:border-0 file:bg-ash-red file:text-white hover:file:bg-red-700 transition" required>
    
    <p class="text-xs text-ash-red mt-2">
        **IMPORTANT:** Contact Customer Service with your payment Order ID as the payment narrative.
    </p>
</div>
                                </div>
                            </div>
                        
                            <div class="mt-6 border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center">
                                    <p class="text-lg font-bold text-ash-dark">Total Due Now</p>
                                    <p id="final-total-due" class="text-2xl font-extrabold text-ash-red" data-total-amount="0">â‚¦<span id="summary-estimated-total-final">0.00</span></p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">By clicking "Confirm & Pay Now", you agree to our Terms of Use.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="pt-6 border-t border-gray-200">
                    <button id="checkout-next-btn" class="w-full bg-ash-red text-white hover:bg-red-700 transition duration-300 font-semibold py-4 rounded-sm shadow-lg uppercase tracking-widest text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="checkout-btn-text">Continue to Review</span>
                    </button>
                    <a href="cart.html" class="mt-4 block text-center text-sm font-medium text-gray-600 hover:text-ash-red transition">
                        &leftarrow; Return to Cart
                    </a>
                </div>

            </div>
            
            <div class="mt-8 lg:mt-0 lg:col-span-1">
                <div class="bg-color-white p-6 rounded-lg shadow-xl border border-gray-100 lg:sticky lg:top-20">
                    <h2 class="text-xl font-bold text-ash-dark mb-6">Order Summary</h2>

                    <div class="space-y-4">
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Subtotal (Items)</span>
                            <span id="summary-subtotal" class="font-semibold">â‚¦0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Shipping</span>
                            <span id="summary-shipping-cost" class="font-semibold">â‚¦0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 border-t border-gray-200 pt-4">
                            <span>Tax Estimate (0%)</span>
                            <span id="summary-tax-estimate" class="font-semibold">â‚¦0.00</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-300 pt-4 mt-6 flex justify-between items-center">
                        <p class="text-lg font-bold text-ash-dark">Estimated Total</p>
                        <p id="summary-estimated-total" class="text-xl font-extrabold text-ash-red">â‚¦0.00</p>
                    </div>

                    <p class="text-xs text-gray-500 mt-2 text-right">Final price includes all duties and fees.</p>

                    <div class="mt-6 border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-semibold text-ash-dark mb-3">Guaranteed Security</h3>
                        <div class="flex items-center text-sm text-gray-700 space-x-4">
                            <i class="fas fa-lock text-lg text-green-600"></i>
                            <p>All transactions are secured by **Paystack**.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <footer class="bg-gray-900 text-gray-300 py-10 sm:py-14 border-t border-gray-800 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-8">
                
                <div class="col-span-2 lg:col-span-1">
                    <a href="homepage.html" class="flex items-center mb-4">
                        <img src="https://i.imgur.com/PZLMws6.jpeg" alt="Outflickz Logo" class="w-auto h-8 filter grayscale invert">
                    </a>
                    <p class="text-sm text-gray-500">
                        The home of exclusive street wear and limited edition drops. Elevate your style.
                    </p>
                    <div class="flex space-x-4 mt-4 text-gray-400">
                        <a href="#" aria-label="Instagram" class="hover:text-ash-red transition"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="Twitter" class="hover:text-ash-red transition"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Facebook" class="hover:text-ash-red transition"><i class="fab fa-facebook-f"></i></a>
                    </div>
                </div>

                <div class="col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="wearscollection.html" class="text-gray-400 hover:text-ash-red transition">Wears</a></li>
                        <li><a href="capcollection.html" class="text-gray-400 hover:text-ash-red transition">Caps</a></li>
                        <li><a href="newarrivals.html" class="text-gray-400 hover:text-ash-red transition">New Arrivals</a></li>
                        <li><a href="preorder.html" class="text-gray-400 hover:text-ash-red transition">Pre-Order</a></li>
                    </ul>
                </div>

                <div class="col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Customer Care</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Contact Us</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Shipping & Returns</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">FAQ</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Size Guide</a></li>
                    </ul>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Get In Touch</h3>
                    <address class="text-sm not-italic space-y-2">
                        <p class="text-gray-400">
                            <i class="fas fa-map-marker-alt mr-2 text-ash-red"></i> 123 Streetwear Ave, City, Country
                        </p>
                        <p class="text-gray-400">
                            <i class="fas fa-envelope mr-2 text-ash-red"></i> support@outflickz.com
                        </p>
                        <p class="text-gray-400">
                            <i class="fas fa-phone mr-2 text-ash-red"></i> +1 (555) 123-4567
                        </p>
                    </address>
                </div>
            </div>

            <div class="border-t border-gray-800 mt-10 pt-6">
                <p class="text-center text-xs text-gray-500">
                    &copy; 2025 Outflickz. All rights reserved. | <a href="#" class="hover:text-ash-red">Privacy Policy</a> | <a href="#" class="hover:text-ash-red">Terms of Use</a>
                </p>
            </div>
        </div>
    </footer>
    
    <a href="https://wa.me/2347042882706?text=HELLO!%20WELCOME%20TO%20OUTFLICKZ!%20HOW%20CAN%20WE%20HELP%20YOU" 
        target="_blank" 
        class="fixed bottom-6 right-6 z-50 bg-[#25D366] text-white p-3 sm:p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" 
        aria-label="Chat with us on WhatsApp">
        <i class="fab fa-whatsapp text-2xl sm:text-3xl"></i>
    </a>

   <script>
Â  Â  Â  Â  // Customizing Tailwind colors to match the theme
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ash-dark': '#111111',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'ash-red': '#a80000',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'color-white': '#FFFFFF',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'color-black': '#000000',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'racing-grey': '#333333',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'racing-silver': '#AAAAAA',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  
Â  Â  Â  Â  // Global Constants (Reused from cart.html)
Â  Â  Â  Â  const CART_STORAGE_KEY = 'outflickzCartCount';
Â  Â  Â  Â  const LOCAL_CART_KEY = 'outflickzLocalCart';
Â  Â  Â  Â  const API_BASE_URL = 'https://outflickz.netlify.app'; // Assuming this is your base path

Â  Â  Â  Â  // --- PAYSTACK CONSTANTS ---
Â  Â  Â  Â  const PAYSTACK_PUBLIC_KEY = 'pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; // <<< REPLACE THIS WITH YOUR ACTUAL PUBLIC KEY!
Â  Â  Â  Â  const CURRENCY_CODE = 'NGN'; // Nigerian Naira

Â  Â  Â  Â  // --- MESSAGE & MODAL DISPLAY FUNCTION (Reused) ---
Â  Â  Â  Â  function displayMessage(message) {
Â  Â  Â  Â  Â  Â  const modalContainer = document.getElementById('message-modal-container');
Â  Â  Â  Â  Â  Â  const modalText = document.getElementById('message-modal-text');

Â  Â  Â  Â  Â  Â  if (modalContainer && modalText) {
Â  Â  Â  Â  Â  Â  Â  Â  modalText.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  modalContainer.classList.remove('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  modalContainer.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target === modalContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideMessageModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(hideMessageModal, 4000);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Modal elements not found. Message:", message);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMessageModal() {
Â  Â  Â  Â  Â  Â  const modalContainer = document.getElementById('message-modal-container');
Â  Â  Â  Â  Â  Â  if (modalContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  modalContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  modalContainer.onclick = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- USER AUTHENTICATION & REDIRECTION FUNCTIONS (Reused) ---
Â  Â  Â  Â  function isUserLoggedIn() {
Â  Â  Â  Â  Â  Â  return localStorage.getItem('outflickzAuthStatus') === 'loggedIn';
Â  Â  Â  Â  }

Â  Â  Â  Â  function redirectToProfileOrLogin() {
Â  Â  Â  Â  Â  Â  if (isUserLoggedIn()) {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'userprofile.html';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'useraccount.html';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function updateCartBadge() {
Â  Â  Â  Â  Â  Â  const badge = document.getElementById('cart-badge');
Â  Â  Â  Â  Â  Â  if (!badge) return;
Â  Â  Â  Â  Â  Â  const count = parseInt(localStorage.getItem(CART_STORAGE_KEY) || '0');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  badge.textContent = count;
Â  Â  Â  Â  Â  Â  Â  Â  badge.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  badge.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- NEW: FETCH USER DATA TO PRE-FILL FORM ---
Â  Â  Â  Â  async function fetchUserData() {
Â  Â  Â  Â  Â  Â  if (!isUserLoggedIn()) {
Â  Â  Â  Â  Â  Â  Â  Â  // If not logged in, rely on user input
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Assuming your backend has an endpoint to get the logged-in user's profile/address
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/users/account', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Include Authorization header if needed by your API
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Failed to fetch user data. Please log in again.');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const userData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  // Expected userData structure: { firstName, lastName, email, phone, address: { street, city, state, zipCode, country } }

Â  Â  Â  Â  Â  Â  Â  Â  // Pre-fill Contact Info
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('email').value = userData.email || '';

Â  Â  Â  Â  Â  Â  Â  Â  // Pre-fill Shipping Info (if available)
Â  Â  Â  Â  Â  Â  Â  Â  if (userData.firstName) document.getElementById('first-name').value = userData.firstName;
Â  Â  Â  Â  Â  Â  Â  Â  if (userData.lastName) document.getElementById('last-name').value = userData.lastName;

Â  Â  Â  Â  Â  Â  Â  Â  if (userData.address) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const address = userData.address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (address.street) document.getElementById('address-line-1').value = address.street;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (address.city) document.getElementById('city').value = address.city;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (address.state) document.getElementById('state').value = address.state;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (address.zipCode) document.getElementById('zip-code').value = address.zipCode;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (address.country) document.getElementById('country').value = address.country;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Save to local storage for use in the review step (Step 2)
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('outflickzShippingData', JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  firstName: userData.firstName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastName: userData.lastName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: userData.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  street: userData.address?.street,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  city: userData.address?.city,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state: userData.address?.state,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  zipCode: userData.address?.zipCode,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  country: userData.address?.country
Â  Â  Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error fetching user data:', error);
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Could not load saved address. Please enter manually.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // ---------------------------------------------------
Â  Â  Â  Â  // --- CHECKOUT LOGIC ---
Â  Â  Â  Â  // ---------------------------------------------------

Â  Â  Â  Â  let checkoutStep = 1; // 1: Info, 2: Review, 3: Payment
Â  Â  Â  Â  const STEPS = [
Â  Â  Â  Â  Â  Â  { id: 1, name: 'Shipping Info', sectionId: 'shipping-info-section' },
Â  Â  Â  Â  Â  Â  { id: 2, name: 'Review Order', sectionId: 'review-order-section' },
Â  Â  Â  Â  Â  Â  { id: 3, name: 'Payment', sectionId: 'payment-section' }
Â  Â  Â  Â  ];

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders the correct step content and updates the step indicators.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateCheckoutView() {
Â  Â  Â  Â  Â  Â  // 1. Update Step Indicators
Â  Â  Â  Â  Â  Â  STEPS.forEach(step => {
Â  Â  Â  Â  Â  Â  Â  Â  const indicator = document.getElementById(`step-indicator-${step.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  const section = document.getElementById(step.sectionId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  section.classList.add('hidden'); // Hide all sections initially

Â  Â  Â  Â  Â  Â  Â  Â  if (step.id < checkoutStep) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.className = 'step-indicator step-complete';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.innerHTML = '<i class="fas fa-check"></i>';
Â  Â  Â  Â  Â  Â  Â  Â  } else if (step.id === checkoutStep) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.className = 'step-indicator step-active';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.textContent = step.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  section.classList.remove('hidden'); // Show current section
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.className = 'step-indicator step-inactive';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indicator.textContent = step.id;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 2. Update button text/action based on the step
Â  Â  Â  Â  Â  Â  const nextBtn = document.getElementById('checkout-next-btn');
Â  Â  Â  Â  Â  Â  const btnText = document.getElementById('checkout-btn-text');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (checkoutStep === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  btnText.textContent = 'Continue to Review';
Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.onclick = validateAndProceedToReview;
Â  Â  Â  Â  Â  Â  } else if (checkoutStep === 2) {
Â  Â  Â  Â  Â  Â  Â  Â  btnText.textContent = 'Proceed to Payment';
Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.onclick = proceedToPayment;
Â  Â  Â  Â  Â  Â  } else if (checkoutStep === 3) {
Â  Â  Â  Â  Â  Â  Â  Â  btnText.textContent = 'Confirm & Pay Now';
Â  Â  Â  Â  Â  Â  Â  Â  nextBtn.onclick = handleFinalOrderPlacement;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  /**
Â  Â  Â  * Validates shipping form data and moves to Step 2 (Review).
Â  Â  Â  */
Â  Â  function validateAndProceedToReview() {
Â  Â  const form = document.getElementById('shipping-form');
Â  Â  
Â  Â  // --- MODIFICATION 3: Make ZIP Code optional by manually checking required fields ---
Â  Â  // Instead of using form.checkValidity(), which depends on 'required' attribute in HTML, 
Â  Â  // we'll rely on the browser's native checkValidity for all *other* fields.
Â  Â  // NOTE: You must also remove the 'required' attribute from the 'zip-code' HTML input.
Â  Â  
Â  Â  // Temporarily remove 'required' from 'zip-code' if it exists for this check
Â  Â  const zipCodeEl = document.getElementById('zip-code');
Â  Â  const isZipRequired = zipCodeEl.hasAttribute('required');
Â  Â  if (isZipRequired) zipCodeEl.removeAttribute('required');

Â  Â  if (!form.checkValidity()) {
Â  Â  Â  Â  // Re-add 'required' if we removed it before showing the error
Â  Â  Â  Â  if (isZipRequired) zipCodeEl.setAttribute('required', '');
Â  Â  Â  Â  
Â  Â  Â  Â  form.reportValidity();
Â  Â  Â  Â  displayMessage('Please fill out all required shipping fields.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // Re-add 'required' if we removed it, now that validation has passed
Â  Â  if (isZipRequired) zipCodeEl.setAttribute('required', '');


Â  Â  // Capture the data
Â  Â  const shippingData = {
Â  Â  Â  Â  firstName: document.getElementById('first-name').value,
Â  Â  Â  Â  lastName: document.getElementById('last-name').value,
Â  Â  Â  Â  email: document.getElementById('email').value,
Â  Â  Â  Â  // --- MODIFICATION 1: REMOVE PHONE NUMBER CAPTURE ---
Â  Â  Â  Â  street: document.getElementById('address-line-1').value,
Â  Â  Â  Â  city: document.getElementById('city').value,
Â  Â  Â  Â  state: document.getElementById('state').value,
Â  Â  Â  Â  zipCode: document.getElementById('zip-code').value, // Optional data is still captured
Â  Â  Â  Â  country: document.getElementById('country').value,
Â  Â  };
Â  Â  localStorage.setItem('outflickzShippingData', JSON.stringify(shippingData));

Â  Â  // Update the review section with the data
Â  Â  document.getElementById('review-address-name').textContent = `${shippingData.firstName} ${shippingData.lastName}`;
Â  Â  document.getElementById('review-address-line1').textContent = shippingData.street;
Â  Â  
Â  Â  // Use optional chaining/nullish coalescing for zipCode in case it's empty
Â  Â  const reviewZipCode = shippingData.zipCode ? `, ${shippingData.zipCode}` : '';
Â  Â  document.getElementById('review-address-line2').textContent = `${shippingData.city}, ${shippingData.state}${reviewZipCode}, ${shippingData.country}`;
Â  Â  
Â  Â  // --- MODIFICATION 1: REMOVE PHONE NUMBER FROM REVIEW DISPLAY ---
Â  Â  document.getElementById('review-contact-info').textContent = `${shippingData.email}` + (shippingData.phone ? ` | ${shippingData.phone}` : ''); // Display phone if available, but email is the focus

Â  Â  checkoutStep = 2;
Â  Â  updateCheckoutView();
Â  Â  window.scrollTo(0, 0); // Scroll to top for new section
}

Â  Â  /**
Â  Â  Â  * Moves to Step 3 (Payment).
Â  Â  Â  */
Â  Â  function proceedToPayment() {
Â  Â  Â  Â  checkoutStep = 3;
Â  Â  Â  Â  updateCheckoutView();
Â  Â  Â  Â  window.scrollTo(0, 0); // Scroll to top for new section
Â  Â  }

Â  Â  /**
Â  Â  Â  * Fetches the initial cart data from the backend API.
Â  Â  Â  */
Â  Â  async function fetchInitialCartData() {
Â  Â  Â  Â  const currencySymbol = 'â‚¦'; // Assuming 'â‚¦' is the correct currency symbol
Â  Â  Â  Â  const subtotalEl = document.getElementById('summary-subtotal');
Â  Â  Â  Â  const shippingCostEl = document.getElementById('summary-shipping-cost');
Â  Â  Â  Â  const taxEstimateEl = document.getElementById('summary-tax-estimate');
Â  Â  Â  Â  const estimatedTotalEl = document.getElementById('summary-estimated-total');
Â  Â  Â  Â  const finalTotalEl = document.getElementById('summary-estimated-total-final'); // Added for step 3
Â  Â  Â  Â  const itemsListEl = document.getElementById('review-items-list');
Â  Â  Â  Â  const paymentBtn = document.getElementById('checkout-next-btn');
Â  Â  Â  Â  
Â  Â  Â  Â  // Set loading state
Â  Â  Â  Â  subtotalEl.textContent = '...';
Â  Â  Â  Â  shippingCostEl.textContent = '...';
Â  Â  Â  Â  taxEstimateEl.textContent = '...';
Â  Â  Â  Â  estimatedTotalEl.textContent = '...';
Â  Â  Â  Â  finalTotalEl.textContent = '...'; // Added for step 3
Â  Â  Â  Â  itemsListEl.innerHTML = '<div class="text-center py-6 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Loading cart data...</div>';
Â  Â  Â  Â  paymentBtn.disabled = true;

Â  Â  Â  Â  // Redirect unauthenticated user
Â  Â  Â  Â  if (!isUserLoggedIn()) {
Â  Â  Â  Â  Â  Â  const localCart = JSON.parse(localStorage.getItem(LOCAL_CART_KEY) || '[]');
Â  Â  Â  Â  Â  Â  if (localCart.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Your cart is empty. Redirecting to home.');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => window.location.href = 'homepage.html', 1500);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  // NOTE: We don't redirect here, we let the user fill in the details manually.
Â  Â  Â  Â  }


Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // === REAL API CALL START ===
Â  Â  Â  Â  Â  Â  // This is a placeholder for your actual server-side cart calculation endpoint.
Â  Â  Â  Â  Â  Â  const response = await fetch('/api/users/cart', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add any necessary headers like Authorization/CORS if needed by your API
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // If the response is not 2xx, throw an error
Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.message || 'Failed to fetch cart data from API.');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const cartData = await response.json();
Â  Â  Â  Â  Â  Â  /* cartData structure is expected to be:
Â  Â  Â  Â  Â  Â  { 
Â  Â  Â  Â  Â  Â  Â  Â  items: [{name, size, color, quantity, price, imageUrl}], 
Â  Â  Â  Â  Â  Â  Â  Â  subtotal: 32000.00, 
Â  Â  Â  Â  Â  Â  Â  Â  shipping: 2500.00, 
Â  Â  Â  Â  Â  Â  Â  Â  tax: 1725.00, 
Â  Â  Â  Â  Â  Â  Â  Â  estimatedTotal: 36225.00 
Â  Â  Â  Â  Â  Â  } */
Â  Â  Â  Â  Â  Â  // === REAL API CALL END ===


Â  Â  Â  Â  Â  Â  if (cartData.items.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Your cart is empty. Redirecting to home.');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => window.location.href = 'homepage.html', 1500);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Render Summary
Â  Â  Â  Â  Â  Â  const subtotal = cartData.subtotal || 0;
Â  Â  Â  Â  Â  Â  const shipping = cartData.shipping || 0;
Â  Â  Â  Â  Â  Â  const tax = cartData.tax || 0;
Â  Â  Â  Â  Â  Â  const total = cartData.estimatedTotal || (subtotal + shipping + tax);

Â  Â  Â  Â  Â  Â  subtotalEl.textContent = `${currencySymbol}${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
Â  Â  Â  Â  Â  Â  shippingCostEl.textContent = `${currencySymbol}${shipping.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
Â  Â  Â  Â  Â  Â  taxEstimateEl.textContent = `${currencySymbol}${tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
Â  Â  Â  Â  Â  Â  estimatedTotalEl.textContent = `${currencySymbol}${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
Â  Â  Â  Â  Â  Â  finalTotalEl.textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2 }); // For Step 3

Â  Â  Â  Â  Â  Â  // Render Review Items List
Â  Â  Â  Â  Â  Â  itemsListEl.innerHTML = cartData.items.map(item => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start py-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${item.imageUrl}" alt="${item.name}" class="w-10 h-10 rounded-md border mr-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-medium text-gray-900">${item.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">${item.size} / ${item.color} (Qty: ${item.quantity})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-900">${currencySymbol}${(item.price * item.quantity).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');

Â  Â  Â  Â  Â  Â  // Store the final total for payment simulation
Â  Â  Â  Â  Â  Â  localStorage.setItem('outflickzOrderTotal', total.toFixed(2));

Â  Â  Â  Â  Â  Â  // Enable button
Â  Â  Â  Â  Â  Â  paymentBtn.disabled = false;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching cart data for checkout:', error);
Â  Â  Â  Â  Â  Â  itemsListEl.innerHTML = '<div class="text-center py-6 text-red-500">Error loading cart. Please go back to cart.</div>';
Â  Â  Â  Â  Â  Â  displayMessage(error.message || 'An error occurred loading your cart. Please try again.');
Â  Â  Â  Â  Â  Â  paymentBtn.disabled = true;
Â  Â  Â  Â  }
Â  Â  }


Â  Â  /**
Â  Â  Â  * Handles the final step: Payment confirmation and order creation (Updated for Paystack/Bank Transfer).
Â  Â  Â  */
Â  Â  async function handleFinalOrderPlacement() {
Â  Â  Â  Â  const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
Â  Â  Â  Â  if (!paymentMethod) {
Â  Â  Â  Â  Â  Â  displayMessage('Please select a payment method.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const totalAmount = parseFloat(localStorage.getItem('outflickzOrderTotal') || 0);
Â  Â  Â  Â  const shippingAddress = JSON.parse(localStorage.getItem('outflickzShippingData'));
Â  Â  Â  Â  const email = shippingAddress?.email;

Â  Â  Â  Â  if (totalAmount <= 0 || !shippingAddress || !email) {
Â  Â  Â  Â  Â  Â  displayMessage('Order or contact data missing. Please refresh and try again.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Disable button to prevent double submission
Â  Â  Â  Â  const payBtn = document.getElementById('checkout-next-btn');
Â  Â  Â  Â  payBtn.disabled = true;
Â  Â  Â  Â  payBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Initializing Payment...';

Â  Â  Â  Â  if (paymentMethod.value === 'Paystack/Card') {
Â  Â  Â  Â  Â  Â  // --- PAYSTACK INITIATION ---
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // NOTE: For production, Paystack recommends generating the reference (and possibly order) 
Â  Â  Â  Â  Â  Â  // on the server before initiating pop, but generating client-side is faster for testing.
Â  Â  Â  Â  Â  Â  const reference = `outflickz_${Date.now()}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Paystack script is now included in the head, so it should be defined
Â  Â  Â  Â  Â  Â  if (typeof PaystackPop === 'undefined') {
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Paystack script not loaded. Please check your internet connection and page HTML.');
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const handler = PaystackPop.setup({
Â  Â  Â  Â  Â  Â  Â  Â  key: PAYSTACK_PUBLIC_KEY,
Â  Â  Â  Â  Â  Â  Â  Â  email: email,
Â  Â  Â  Â  Â  Â  Â  Â  amount: totalAmount * 100, // Paystack expects amount in Kobo
Â  Â  Â  Â  Â  Â  Â  Â  ref: reference,
Â  Â  Â  Â  Â  Â  Â  Â  currency: CURRENCY_CODE,
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Callback runs when user completes the payment process in the modal
Â  Â  Â  Â  Â  Â  Â  Â  callback: function(response){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // The backend webhook (POST /api/paystack/webhook) will handle the official verification
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Payment successful! Finalizing order on the server...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Redirect to a confirmation/waiting page using the Paystack reference
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = `orderconfirmation.html?ref=${response.reference}&method=paystack`;
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  onClose: function(){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Re-enable button if user closes the modal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Payment cancelled or abandoned. Please try again.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Open the payment modal
Â  Â  Â  Â  Â  Â  handler.openIframe();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Return to prevent the default API call
Â  Â  Â  Â  Â  Â  return; 

Â  Â  Â  Â  } else if (paymentMethod.value === 'Bank Transfer') {
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- NEW: VALIDATE RECEIPT UPLOAD ---
Â  Â  Â  Â  Â  Â  const receiptInput = document.getElementById('bank-receipt-upload');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Check if the receipt input exists and has a file attached
Â  Â  Â  Â  Â  Â  if (!receiptInput || !receiptInput.files || receiptInput.files.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('Please upload the payment receipt image to complete the bank transfer order.');
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Optional: Focus on the input to help the user
Â  Â  Â  Â  Â  Â  Â  Â  if (receiptInput) receiptInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // File is present, proceed with order placement (simulated API call)
Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Placing Order...';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- BANK TRANSFER (PENDING ORDER) INITIATION ---
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // NOTE: In a real application, the uploaded file (receiptInput.files[0]) 
Â  Â  Â  Â  Â  Â  // would need to be sent to the server, typically using FormData, to be stored 
Â  Â  Â  Â  Â  Â  // alongside the new order. The below fetch is a placeholder for order creation.

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // REAL FETCH: Create a pending order on the server
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/orders/place/pending', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shippingAddress: shippingAddress,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  paymentMethod: paymentMethod.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalAmount: totalAmount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // The server should retrieve the cart items from the user's session/DB
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const isSuccess = response.ok; // Check if the response status is 200-299

Â  Â  Â  Â  Â  Â  Â  Â  if (isSuccess && data.orderId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Success: Redirect to a page showing bank details and the new Order ID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayMessage(`Pending Order #${data.orderId} created! Redirecting to confirmation page.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Clear local storage items only if the order was successfully created on the server
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(LOCAL_CART_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(CART_STORAGE_KEY, '0');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('outflickzOrderTotal');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateCartBadge();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = `orderconfirmation.html?id=${data.orderId}&method=banktransfer`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 3000);

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(data.message || 'Failed to create pending order. Please check server response.');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Pending order placement error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  displayMessage(error.message || 'A network error occurred. Please try again.');
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Fallback for other payment methods if needed
Â  Â  Â  Â  Â  Â  displayMessage(`Payment method ${paymentMethod.value} selected, but not yet implemented.`);
Â  Â  Â  Â  Â  Â  payBtn.disabled = false;
Â  Â  Â  Â  Â  Â  payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Main Initialization ---
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  // Initial checks and data loading
Â  Â  Â  Â  updateCartBadge();
Â  Â  Â  Â  fetchInitialCartData();
Â  Â  Â  Â  updateCheckoutView(); // Initialize step 1 view
Â  Â  Â  Â  fetchUserData(); // NEW: Pre-fill user data if logged in

Â  Â  Â  Â  // Attach the hideMessageModal function to the close button
Â  Â  Â  Â  const closeButton = document.getElementById('message-modal-close-btn');
Â  Â  Â  Â  if (closeButton) {
Â  Â  Â  Â  Â  Â  closeButton.addEventListener('click', hideMessageModal);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Bank Details Toggle Initialization ---
Â  Â  Â  Â  const bankRadio = document.getElementById('payment-bank');
Â  Â  Â  Â  const paystackRadio = document.getElementById('payment-paystack');
Â  Â  Â  Â  const bankDetails = document.getElementById('bank-details-info');
Â  Â  Â  Â  // NEW: Get the receipt upload element
Â  Â  Â  Â  const receiptUpload = document.getElementById('bank-receipt-upload');

Â  Â  Â  Â  function toggleBankDetails() {
Â  Â  Â  Â  Â  Â  if (bankDetails && receiptUpload) {
Â  Â  Â  Â  Â  Â  Â  Â  // Check if the bank radio button exists and is checked
Â  Â  Â  Â  Â  Â  Â  Â  const isBankChecked = bankRadio && bankRadio.checked;
Â  Â  Â  Â  Â  Â  Â  Â  bankDetails.style.display = isBankChecked ? 'block' : 'none';

Â  Â  Â  Â  Â  Â  Â  Â  // Set the required attribute dynamically
Â  Â  Â  Â  Â  Â  Â  Â  if (isBankChecked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  receiptUpload.setAttribute('required', 'required');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  receiptUpload.removeAttribute('required');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (bankRadio) bankRadio.addEventListener('change', toggleBankDetails);
Â  Â  Â  Â  if (paystackRadio) paystackRadio.addEventListener('change', toggleBankDetails);

Â  Â  Â  Â  // Initial check in case bank transfer is the default selected option
Â  Â  Â  Â  toggleBankDetails(); 
Â  Â  });
</script>
</body>
</html>