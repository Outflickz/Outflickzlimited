<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outflickz - User Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <style>
        /* Modernized Tailwind Configuration */
        :focus:not(:focus-visible) {
            outline: none;
        }
        /* Custom transition for view switching - slightly faster and smoother */
        .view-transition {
            transition: opacity 0.4s ease-in-out;
        }
        /* Hide default clear button for password field in some browsers */
        input[type=password]::-ms-reveal,
        input[type=password]::-ms-clear {
            display: none;
        }

        /* Responsive Body Background with Subtle Gradient for Desktop */
        body {
            background-color: #f3f4f6; /* bg-gray-100 fallback */
            background-image: linear-gradient(135deg, #f7f9fb 0%, #eef1f5 100%);
        }

        /* Enhanced Container Styling */
        .auth-container {
            /* Max width remains 448px (max-w-md) to keep it focused */
            /* Add a subtle 3D lift */
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 sm:p-6 md:p-8">

    <div class="w-full max-w-sm sm:max-w-md bg-white shadow-xl rounded-xl p-6 sm:p-8 md:p-10 auth-container">
        
        <div class="flex flex-col items-center mb-8">
            <img 
                src="https://i.imgur.com/1Rxhi9q.jpeg" 
                alt="Outflickz Logo" 
                class="w-16 h-auto mb-3 rounded-full shadow-md"
            >
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-wider">
                OUTFLICKZ
            </h1>
            <p id="auth-header" class="text-gray-500 mt-1 text-base sm:text-lg font-medium">Welcome Back</p>
        </div>

        <div id="auth-views" class="relative overflow-hidden">
            
            <div id="login-view" class="view-transition">
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-semibold text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="login-email" name="email" required 
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out placeholder-gray-400"
                            placeholder="you@example.com"
                        >
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" name="password" required 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out pr-16 placeholder-gray-400"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            >
                            <button type="button" onclick="togglePasswordVisibility('login-password')" 
                                class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="toggle-login-password"
                                aria-label="Toggle password visibility"
                            >
                                View
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500/50">
                        Log In
                    </button>
                </form>

                <div class="mt-6 text-center text-sm">
                    <button onclick="showView('forgot')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-medium focus:outline-none focus:underline">
                        Forgot Password?
                    </button>
                    <span class="text-gray-400 mx-2">|</span>
                    <button onclick="showView('create')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-medium focus:outline-none focus:underline">
                        Create an Account
                    </button>
                </div>
            </div>

            <div id="create-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <form id="create-form" onsubmit="handleCreateAccount(event)">
                    
                    <div class="mb-4 flex space-x-4">
                        <div class="w-1/2">
                            <label for="create-firstName" class="block text-sm font-semibold text-gray-700 mb-1">First Name (Optional)</label>
                            <input type="text" id="create-firstName" name="firstName" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out placeholder-gray-400"
                                placeholder="John"
                            >
                        </div>
                        <div class="w-1/2">
                            <label for="create-lastName" class="block text-sm font-semibold text-gray-700 mb-1">Last Name (Optional)</label>
                            <input type="text" id="create-lastName" name="lastName" 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out placeholder-gray-400"
                                placeholder="Doe"
                            >
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="create-email" class="block text-sm font-semibold text-gray-700 mb-1">Email Address <span class="text-red-500">*</span></label>
                        <input type="email" id="create-email" name="email" required 
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out placeholder-gray-400"
                            placeholder="your.new@example.com"
                        >
                    </div>
                    <div class="mb-4">
                        <label for="create-password" class="block text-sm font-semibold text-gray-700 mb-1">Password <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="password" id="create-password" name="password" required 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out pr-16 placeholder-gray-400"
                                placeholder="Min 8 characters"
                            >
                            <button type="button" onclick="togglePasswordVisibility('create-password')" 
                                class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="toggle-create-password"
                                aria-label="Toggle password visibility"
                            >
                                View
                            </button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-1">Confirm Password <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="password" id="confirm-password" name="confirmPassword" required 
                                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out pr-16 placeholder-gray-400"
                                placeholder="Re-enter password"
                            >
                            <button type="button" onclick="togglePasswordVisibility('confirm-password')" 
                                class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                id="toggle-confirm-password"
                                aria-label="Toggle password visibility"
                            >
                                View
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" id="create-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-500/50">
                        Create Account
                    </button>
                </form>

                <div class="mt-6 text-center text-sm">
                    <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-medium focus:outline-none focus:underline">
                        Back to Login
                    </button>
                </div>
            </div>

            <div id="verify-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <form id="verify-form" onsubmit="handleVerification(event)">
                    <p class="text-sm text-gray-600 mb-6 text-center">
                        A verification code has been sent to 
                        <strong id="verify-email-display" class="text-gray-800"></strong>. Please enter the 6-digit code below to activate your account.
                    </p>
                    <div class="mb-6">
                        <label for="verify-code" class="sr-only">Verification Code</label>
                        <input type="text" id="verify-code" name="code" required minlength="6" maxlength="6"
                            class="w-full px-4 py-3 text-center text-2xl font-extrabold border-2 border-gray-300 rounded-lg tracking-widest focus:ring-purple-500 focus:border-purple-500 transition duration-150 ease-in-out"
                            placeholder="000000"
                            inputmode="numeric"
                        >
                    </div>
                    
                    <button type="submit" id="verify-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-purple-500/50">
                        Verify Account
                    </button>
                </form>

                <div class="mt-6 text-center text-sm">
                    <button onclick="handleResendCode()" id="resend-btn" class="text-purple-600 hover:text-purple-800 transition duration-150 ease-in-out font-medium focus:outline-none focus:underline">
                        Resend Code
                    </button>
                </div>
            </div>
            
            <div id="forgot-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <form id="forgot-form" onsubmit="handleForgotPassword(event)">
                    <p class="text-sm text-gray-600 mb-6 text-center">
                        Enter your email address and we'll send you a link to reset your password.
                    </p>
                    <div class="mb-6">
                        <label for="forgot-email" class="block text-sm font-semibold text-gray-700 mb-1">Email Address</label>
                        <input type="email" id="forgot-email" name="email" required 
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out placeholder-gray-400"
                            placeholder="you@example.com"
                        >
                    </div>
                    
                    <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-yellow-500/50">
                        Send Reset Link
                    </button>
                </form>

                <div class="mt-6 text-center text-sm">
                    <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-medium focus:outline-none focus:underline">
                        Back to Login
                    </button>
                </div>
            </div>

            <div id="profile-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3 flex items-center">
                    <span class="mr-2 text-blue-600">üë§</span>Your Profile
                </h2>
                
                <div id="profile-details">
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg shadow-sm">
                            <h3 class="font-bold text-blue-800 mb-1">Personal Information</h3>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">ID:</span> <span id="profile-id" class="font-medium">N/A</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Email:</span> <span id="profile-email" class="font-medium">N/A</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Name:</span> <span id="profile-name" class="font-medium">N/A</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Username:</span> <span id="profile-username" class="font-medium">N/A</span></p>
                        </div>

                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg shadow-sm">
                            <h3 class="font-bold text-green-800 mb-1">Account Status</h3>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Role:</span> <span id="profile-role" class="font-medium">N/A</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Verified:</span> <span id="profile-verified" class="font-medium">N/A</span></p>
                        </div>
                        
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg shadow-sm">
                            <h3 class="font-bold text-yellow-800 mb-1">Membership</h3>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Member Since:</span> <span id="profile-member-since" class="font-medium">N/A</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold text-gray-700">Last Updated:</span> <span id="profile-last-updated" class="font-medium">N/A</span></p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-red-500/50">
                        Log Out
                    </button>
                </div>
            </div>
            
            <div id="message-area" class="mt-6 p-3 text-sm rounded-lg hidden" role="alert" aria-live="polite"></div>

        </div>
    </div>

 <script>
    // *** 1. CONFIGURATION ***
    // FIX: CHANGED BASE URL to use the clean "/api" path defined in netlify.toml, 
    // which Netlify automatically redirects to the correct function path.
    const API_BASE_URL = 'https://outflickz.netlify.app/api'; 
    const REGISTER_ENDPOINT = `${API_BASE_URL}/users/register`; 
    const VERIFY_ENDPOINT = `${API_BASE_URL}/users/verify`; 
    const RESEND_ENDPOINT = `${API_BASE_URL}/users/resend-verification`; 
    const LOGIN_ENDPOINT = `${API_BASE_URL}/users/login`; 


    let pendingVerificationEmail = ''; 
    
    // Initial assignment must happen after DOMContentLoaded for production code, 
    // but we define the variables here for clarity.
    let views = {};
    let headerElement;
    let messageArea;
    let container;

    /**
     * Switches the active authentication view with a fade transition.
     */
    function showView(viewName) {
        let currentView = Object.values(views).find(v => v.classList.contains('opacity-100') && !v.classList.contains('hidden'));
        
        const headers = {
            'login': 'Welcome Back',
            'create': 'Create Your Account',
            'verify': 'Account Verification',
            'forgot': 'Reset Your Password',
            'profile': 'Your Account Dashboard'
        };
        headerElement.textContent = headers[viewName] || 'Authentication';
        
        if (viewName !== 'profile') {
            messageArea.classList.add('hidden');
            messageArea.innerHTML = '';
        }

        const nextView = views[viewName];

        if (currentView) {
            currentView.classList.remove('opacity-100');
            currentView.classList.add('opacity-0');
            container.style.height = `${container.offsetHeight}px`;

            setTimeout(() => {
                currentView.classList.add('hidden');
                currentView.classList.remove('absolute');
                
                nextView.classList.remove('hidden');
                nextView.classList.add('absolute');
                
                container.style.height = 'auto';

                setTimeout(() => {
                    nextView.classList.remove('absolute');
                    container.style.height = `${container.offsetHeight}px`;

                    nextView.classList.remove('opacity-0');
                    nextView.classList.add('opacity-100');

                    setTimeout(() => {
                        container.style.height = '';
                    }, 400); // Wait for the opacity transition to complete
                }, 50); 
            }, 400); // Wait for the fade-out to complete
        } else {
            nextView.classList.remove('hidden');
            nextView.classList.remove('opacity-0');
            nextView.classList.add('opacity-100');
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize DOM elements after load
        views = {
            'login': document.getElementById('login-view'),
            'create': document.getElementById('create-view'),
            'verify': document.getElementById('verify-view'),
            'forgot': document.getElementById('forgot-view'),
            'profile': document.getElementById('profile-view') 
        };
        headerElement = document.getElementById('auth-header');
        messageArea = document.getElementById('message-area');
        container = document.getElementById('auth-views');

        showView('login');
    });

    /**
     * Toggles password input type between 'password' and 'text'.
     */
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = document.getElementById(`toggle-${fieldId}`);
        
        if (field.type === 'password') {
            field.type = 'text';
            button.textContent = 'Hide';
        } else {
            field.type = 'password';
            button.textContent = 'View';
        }
    }

    /**
     * Displays a temporary message.
     */
    function displayMessage(message, type = 'info') {
        const baseClasses = 'mt-6 p-4 text-sm rounded-lg font-medium'; 
        messageArea.className = baseClasses;
        messageArea.innerHTML = message;
        
        switch (type) {
            case 'success':
                messageArea.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                break;
            case 'error':
                messageArea.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                break;
            default: // 'info'
                messageArea.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
                break;
        }
        messageArea.classList.remove('hidden');
    }

    /**
     * Placeholder function for handling login form submission to redirect to homepage.html.
     */
    function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        
        loginBtn.textContent = 'Logging in...';
        loginBtn.disabled = true;

        // --- Mock Login Logic (Replace with real API call) ---
        setTimeout(() => {
            loginBtn.textContent = 'Log In';
            loginBtn.disabled = false;

            // Mock login to show the profile view
            if (email === 'profile@outflickz.com' && password === 'password') {
                 populateProfileView({
                    id: 'u-54321',
                    email: 'profile@outflickz.com',
                    name: 'Jane Smith',
                    username: 'OutflickzPro',
                    role: 'Premium Member',
                    verified: true,
                    memberSince: 'Mar 2023',
                    lastUpdated: new Date().toLocaleDateString()
                });
                showView('profile');
                displayMessage('Successfully logged in. Viewing profile.', 'success');

            } else if (email === 'test@outflickz.com' && password === 'password') {
                // Success - display message and redirect
                displayMessage(`Login successful! Redirecting to homepage...`, 'success');
                
                setTimeout(() => {
                    window.location.href = 'homepage.html'; 
                }, 500); 
            } else {
                displayMessage('Login failed. Please check your email and password.', 'error');
            }
        }, 1500); 
    }

    /**
     * Handles create account form submission and transitions to verification view.
     */
    async function handleCreateAccount(event) {
        event.preventDefault();
        const form = event.target;
        const email = document.getElementById('create-email').value;
        const password = document.getElementById('create-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const createBtn = document.getElementById('create-btn');

        if (password !== confirmPassword) {
            displayMessage('Passwords do not match.', 'error');
            return;
        }
        if (password.length < 8) {
            displayMessage('Password must be at least 8 characters.', 'error');
            return;
        }

        createBtn.textContent = 'Creating...';
        createBtn.disabled = true;
        displayMessage('Attempting to create account via /api/register...', 'info');

        try {
            const response = await fetch(REGISTER_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    email: email,
                    password: password
                })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                 // Throwing an error here prevents the "Unexpected end of JSON input" error on 404/500
                 throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                // Success: Account created, verification code sent
                pendingVerificationEmail = email;
                document.getElementById('verify-email-display').textContent = email;
                
                displayMessage(`Success! Account created. Now check ${email} for your 6-digit verification code.`, 'success');
                
                form.reset();

                setTimeout(() => {
                    showView('verify');
                    setResendCooldown(60); 
                }, 2000); 

            } else {
                // Handle API errors (4xx, 5xx with JSON body)
                const errorMessage = data.message || `API Error (${response.status}): An unexpected error occurred.`;
                displayMessage(`Registration Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            // Handle network errors or the Error thrown by robust parsing
            console.error('Network or API call failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the registration service. Check endpoint configuration.'}`, 'error');
        } finally {
            createBtn.textContent = 'Create Account';
            createBtn.disabled = false;
        }
    }

    /**
     * Handles account verification code submission.
     */
    async function handleVerification(event) {
        event.preventDefault();
        const code = document.getElementById('verify-code').value;
        const verifyBtn = document.getElementById('verify-btn');
        const email = pendingVerificationEmail;
        
        if (!email) {
            displayMessage('Error: No pending email found. Please create an account.', 'error');
            showView('create');
            return;
        }

        verifyBtn.textContent = 'Verifying...';
        verifyBtn.disabled = true;
        
        try {
            const response = await fetch(VERIFY_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: code })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                 throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                displayMessage('Account verified successfully! You can now log in.', 'success');
                
                pendingVerificationEmail = ''; 
                document.getElementById('verify-code').value = '';
                
                setTimeout(() => {
                    showView('login');
                    document.getElementById('login-email').value = email; // Pre-fill email
                }, 2000);

            } else {
                const errorMessage = data.message || `Verification API Error (${response.status}).`;
                displayMessage(`Verification Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            console.error('Verification network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the verification service.'}`, 'error');
        } finally {
            verifyBtn.textContent = 'Verify Account';
            verifyBtn.disabled = false;
        }
    }

    /**
     * Starts a cooldown timer for the Resend Code button.
     */
    function setResendCooldown(durationSeconds = 60) {
        const resendBtn = document.getElementById('resend-btn');
        resendBtn.disabled = true;
        let timer = durationSeconds;
        resendBtn.textContent = `Resend Code (${timer}s)`;

        const interval = setInterval(() => {
            timer--;
            if (timer > 0) {
                resendBtn.textContent = `Resend Code (${timer}s)`;
            } else {
                clearInterval(interval);
                resendBtn.textContent = 'Resend Code';
                resendBtn.disabled = false;
            }
        }, 1000);
    }

    /**
     * Handles resending the verification code with cooldown logic.
     */
    async function handleResendCode() {
        const resendBtn = document.getElementById('resend-btn');
        const email = pendingVerificationEmail;

        if (resendBtn.disabled) {
            // Cooldown is active, just return
            return;
        }
        
        if (!email) {
            showView('create');
            displayMessage('Please create an account first.', 'error');
            return;
        }

        setResendCooldown(60); 
        displayMessage(`Resending code to ${email}...`, 'info');

        try {
            const response = await fetch(RESEND_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                 throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING
            
            if (response.ok) {
                displayMessage('New code successfully sent! Check your inbox.', 'success');
            } else {
                const errorMessage = data.message || `Resend API Error (${response.status}).`;
                displayMessage(`Resend Failed: ${errorMessage}`, 'error');
            }
        } catch (error) {
            console.error('Resend network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the resend service.'}`, 'error');
        }
    }

    /**
     * Placeholder function for handling forgot password form submission.
     */
    function handleForgotPassword(event) {
        event.preventDefault();
        const email = document.getElementById('forgot-email').value;
        // In a real app, send API call to trigger password reset email
        displayMessage(`If an account exists for ${email}, a password reset link has been sent.`, 'success');
        setTimeout(() => {
            showView('login');
        }, 5000);
    }

    /**
     * Placeholder function for handling user logout.
     */
    function handleLogout() {
        // In a real app, clear the token from localStorage here
        displayMessage('You have been successfully logged out.', 'info');
        showView('login');
    }

    // Mock function to populate the profile view (must be called after successful login in a real app)
    function populateProfileView(user) {
        document.getElementById('profile-id').textContent = user.id;
        document.getElementById('profile-email').textContent = user.email;
        document.getElementById('profile-name').textContent = user.name || 'Not Provided';
        document.getElementById('profile-username').textContent = user.username || 'Not Provided';
        document.getElementById('profile-role').textContent = user.role;
        document.getElementById('profile-verified').textContent = user.verified ? 'Yes ‚úÖ' : 'No ‚ùå';
        document.getElementById('profile-member-since').textContent = user.memberSince;
        document.getElementById('profile-last-updated').textContent = user.lastUpdated;
    }
</script>
</body>
</html>