<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outflickz - User Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <style>
        /* Modernized Tailwind Configuration */
        :focus:not(:focus-visible) {
            outline: none;
        }
        /* Custom transition for view switching - smoother, but adjusted for the new layout */
        .view-transition {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }

        /* --- 1. NEW BODY/CONTAINER STYLING FOR SPLIT SCREEN --- */
        body {
            /* Clean black/deep gray background for the full canvas */
            background-color: #1f2937; /* bg-gray-800 */
        }

        /* Desktop Container: Grid Layout */
        @media (min-width: 768px) {
            .app-container {
                /* Set up the 2/3 (form) and 1/3 (branding) split */
                grid-template-columns: 2fr 1fr; /* Form is 2/3, Branding is 1/3 */
                max-width: 1100px; /* Wider desktop canvas */
                min-height: 80vh; 
            }
        }
        
        /* Form Section Styling (Right Side on Desktop) */
        .form-section {
            background-color: #ffffff; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1); 
        }

        /* Branding Sidebar Styling (Left Side on Desktop) */
        .branding-sidebar {
            background: linear-gradient(135deg, #374151 0%, #111827 100%); /* bg-gray-700 to bg-gray-900 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 md:p-8">

    <div class="app-container w-full h-screen md:h-auto md:grid rounded-xl overflow-hidden">
        
        <div class="branding-sidebar hidden md:flex flex-col items-center justify-center p-8 text-white order-2">
            
            <img 
                src="https://i.imgur.com/1Rxhi9q.jpeg" 
                alt="Outflickz Background" 
                class="w-32 h-32 object-cover mb-6 rounded-full border-4 border-white/30 shadow-2xl"
            >
            <h2 class="text-4xl font-extrabold mb-3 tracking-widest text-white">
                OUTFLICKZ
            </h2>
            <p class="text-white/80 text-center text-lg font-light max-w-xs">
                Your Digital Fashion & Movie Hub. Seamless access to exclusive content and styling.
            </p>
            <div class="mt-8 space-y-2 text-sm text-white/70">
                <p>âœ¨ Fast. Secure. Modern.</p>
                <p>ðŸ›’ Cart Sync Included.</p>
            </div>
        </div>

        <div class="form-section w-full max-w-full md:max-w-none p-6 sm:p-10 lg:p-14 md:order-1 flex flex-col justify-center">
            
            <div class="flex flex-col items-center mb-10">
                <img 
                    src="https://i.imgur.com/1Rxhi9q.jpeg" 
                    alt="Outflickz Logo" 
                    class="w-12 h-auto mb-2 rounded-full shadow-md md:hidden"
                >
                <h1 class="text-4xl font-black text-gray-900 tracking-tight">
                    <span id="auth-header" class="text-gray-900">Sign In</span>
                </h1>
                <p class="text-gray-500 mt-2 text-md font-medium">
                    Welcome Back to Outflickz
                </p>
            </div>

            <div id="message-area" class="hidden mt-6 w-full max-w-md mx-auto">
    </div>

            <div id="auth-views" class="relative overflow-hidden w-full max-w-md mx-auto">
                
                <div id="login-view" class="view-transition opacity-100">
                    <form id="login-form" onsubmit="handleLogin(event)">
                        <div class="mb-5">
                            <label for="login-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="login-email" name="email" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                placeholder="Enter your registered email"
                            >
                        </div>
                        <div class="mb-4">
                            <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <div class="relative">
                                <input type="password" id="login-password" name="password" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                >
                                <button type="button" onclick="togglePasswordVisibility('login-password')" 
                                    class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="toggle-login-password"
                                    aria-label="Toggle password visibility"
                                >
                                    View
                                </button>
                            </div>
                            <div class="text-right mt-2">
                                <button type="button" onclick="showView('forgot')" class="text-sm font-medium text-blue-600 hover:text-blue-800 focus:outline-none focus:underline">
                                    Forgot Password?
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" id="login-btn" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-gray-700/50 mt-4">
                            Sign In
                        </button>
                    </form>

                    <div class="mt-8 text-center text-sm">
                        <p class="text-gray-600">
                            Don't have an account? 
                            <button onclick="showView('create')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                                Create an Account
                            </button>
                        </p>
                    </div>
                </div>

                <div id="create-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                    <form id="create-form" onsubmit="handleCreateAccount(event)">
                        
                        <div class="mb-4 flex space-x-4">
                            <div class="w-1/2">
                                <label for="create-firstName" class="block text-sm font-semibold text-gray-700 mb-2">First Name (Optional)</label>
                                <input type="text" id="create-firstName" name="firstName" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                    placeholder="John"
                                >
                            </div>
                            <div class="w-1/2">
                                <label for="create-lastName" class="block text-sm font-semibold text-gray-700 mb-2">Last Name (Optional)</label>
                                <input type="text" id="create-lastName" name="lastName" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                    placeholder="Doe"
                                >
                            </div>
                        </div>

                        <div class="mb-5">
                            <label for="create-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address <span class="text-red-500">*</span></label>
                            <input type="email" id="create-email" name="email" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                placeholder="your.new@example.com"
                            >
                        </div>
                        <div class="mb-4">
                            <label for="create-password" class="block text-sm font-semibold text-gray-700 mb-2">Password <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="password" id="create-password" name="password" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                                    placeholder="Min 8 characters"
                                >
                                <button type="button" onclick="togglePasswordVisibility('create-password')" 
                                    class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="toggle-create-password"
                                    aria-label="Toggle password visibility"
                                >
                                    View
                                </button>
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">Confirm Password <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="password" id="confirm-password" name="confirmPassword" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                                    placeholder="Re-enter password"
                                >
                                <button type="button" onclick="togglePasswordVisibility('confirm-password')" 
                                    class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="toggle-confirm-password"
                                    aria-label="Toggle password visibility"
                                >
                                    View
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" id="create-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500/50">
                            Create Account
                        </button>
                    </form>

                    <div class="mt-8 text-center text-sm">
                        <p class="text-gray-600">
                            Already have an account? 
                            <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                                Back to Sign In
                            </button>
                        </p>
                    </div>
                </div>

                <div id="verify-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                    <form id="verify-form" onsubmit="handleVerification(event)">
                        <p class="text-md text-gray-600 mb-6 text-center">
                            A 6-digit verification code has been sent to 
                            <strong id="verify-email-display" class="text-gray-800 block mt-1"></strong>.
                        </p>
                        <div class="mb-6">
                            <label for="verify-code" class="sr-only">Verification Code</label>
                            <input type="text" id="verify-code" name="code" required minlength="6" maxlength="6"
                                class="w-full px-4 py-4 text-center text-3xl font-extrabold border-2 border-gray-400 rounded-xl tracking-widest focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out text-gray-900"
                                placeholder="000000"
                                inputmode="numeric"
                            >
                        </div>
                        
                        <button type="submit" id="verify-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-500/50">
                            Verify Account
                        </button>
                    </form>

                    <div class="mt-8 text-center text-sm">
                        <p>
                            <button onclick="handleResendCode()" id="resend-btn" class="text-green-600 hover:text-green-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline disabled:opacity-50 disabled:cursor-not-allowed">
                                Resend Code
                            </button>
                            <span class="text-gray-400 mx-2">|</span>
                            <button onclick="showView('login')" class="text-gray-600 hover:text-gray-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                                Cancel & Return to Login
                            </button>
                        </p>
                    </div>
                </div>
                
                <div id="forgot-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                    <form id="forgot-form" onsubmit="handleForgotPassword(event)">
                        <p class="text-md text-gray-600 mb-6 text-center">
                            Enter your email address to receive a link to reset your password.
                        </p>
                        <div class="mb-6">
                            <label for="forgot-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="forgot-email" name="email" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                placeholder="you@example.com"
                            >
                        </div>
                        
                        <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-yellow-500/50">
                            Send Reset Link
                        </button>
                    </form>

                    <div class="mt-8 text-center text-sm">
                        <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                            Back to Sign In
                        </button>
                    </div>
                </div>
        
    </div>
    
<script>
    // *** 1. CONFIGURATION ***
    const API_BASE_URL = 'https://outflickzltd.netlify.app/api';
    const REGISTER_ENDPOINT = `${API_BASE_URL}/users/register`;
    const VERIFY_ENDPOINT = `${API_BASE_URL}/users/verify`;
    const RESEND_ENDPOINT = `${API_BASE_URL}/users/resend-verification`;
    const LOGIN_ENDPOINT = `${API_BASE_URL}/users/login`;

    let pendingVerificationEmail = '';

    let views = {};
    let headerElement;
    let messageArea;
    let container;

    /**
     * Switches the active authentication view with a fade transition.
     */
    function showView(viewName) {
        let currentView = Object.values(views).find(v => v.classList.contains('opacity-100') && !v.classList.contains('hidden'));

        const headers = {
            'login': 'Sign In',
            'create': 'Create Account',
            'verify': 'Verify Account',
            'forgot': 'Reset Password',
        };
        // The error was likely here as 'profile' was not checked:
        headerElement.textContent = headers[viewName] || 'Authentication';

        // Simplifed to always clear message on view change
        messageArea.classList.add('hidden');
        messageArea.innerHTML = '';

        const nextView = views[viewName];

        if (!nextView) {
            console.error(`View '${viewName}' not found.`);
            return;
        }

        if (currentView && currentView !== nextView) {
            currentView.classList.remove('opacity-100');
            currentView.classList.add('opacity-0');

            // Adjust height for smooth transition between views of different sizes
            container.style.height = `${currentView.offsetHeight}px`;

            setTimeout(() => {
                currentView.classList.add('hidden');
                currentView.classList.remove('absolute');

                nextView.classList.remove('hidden');
                nextView.classList.add('absolute');

                // Calculate and set the target height before showing
                container.style.height = `${nextView.offsetHeight}px`;

                setTimeout(() => {
                    nextView.classList.remove('absolute');
                    nextView.classList.remove('opacity-0');
                    nextView.classList.add('opacity-100');

                    // Reset height after transition to allow responsive growth
                    setTimeout(() => {
                        container.style.height = '';
                    }, 400);
                }, 50);
            }, 400);
        } else if (nextView) {
            nextView.classList.remove('hidden');
            nextView.classList.remove('opacity-0');
            nextView.classList.add('opacity-100');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize DOM elements after load
        views = {
            'login': document.getElementById('login-view'),
            'create': document.getElementById('create-view'),
            'verify': document.getElementById('verify-view'),
            'forgot': document.getElementById('forgot-view'),
            // 'profile' view removed
        };
        headerElement = document.getElementById('auth-header');
        messageArea = document.getElementById('message-area');
        container = document.getElementById('auth-views');

        // Check if all essential elements were found
        if (!headerElement || !messageArea || !container || !views.login) {
            console.error("Essential DOM elements for authentication not found. Check HTML IDs.");
            // Stop execution if main elements are missing to prevent runtime errors
            return;
        }

        showView('login');
    });

    /**
     * Toggles password input type between 'password' and 'text'.
     */
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = document.getElementById(`toggle-${fieldId}`);

        if (field.type === 'password') {
            field.type = 'text';
            button.textContent = 'Hide';
        } else {
            field.type = 'password';
            button.textContent = 'View';
        }
    }

    /**
     * Displays a temporary message.
     */
    function displayMessage(message, type = 'info') {
        const baseClasses = 'mt-8 p-4 text-sm rounded-xl font-medium';
        messageArea.className = baseClasses;
        messageArea.innerHTML = message;

        switch (type) {
            case 'success':
                messageArea.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                break;
            case 'error':
                messageArea.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                break;
            default: // 'info'
                messageArea.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300');
                break;
        }
        messageArea.classList.remove('hidden');
    }

    /**
     * Function to handle login form submission with real API call
     */
    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');

        // --- ðŸ”‘ CART MERGE LOGIC - STEP 1: READ LOCAL CART ---
        let localCartItems = [];
        try {
            const localCartJson = localStorage.getItem('outflickzLocalCart');
            if (localCartJson) {
                localCartItems = JSON.parse(localCartJson);
                // Ensure it's an array before sending
                if (!Array.isArray(localCartItems)) {
                    localCartItems = [];
                }
            }
        } catch (e) {
            console.warn('Could not parse local cart data from localStorage:', e);
            localCartItems = [];
        }
        // -----------------------------------------------------

        // 1. Show loading state
        loginBtn.textContent = 'Signing in...';
        loginBtn.disabled = true;
        displayMessage(`Attempting to log in. Local items found: ${localCartItems.length}`, 'info');

        try {
            // 2. Perform the API call
            const response = await fetch(LOGIN_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // --- ðŸ”‘ CART MERGE LOGIC - STEP 2: INCLUDE IN PAYLOAD ---
                body: JSON.stringify({
                    email: email,
                    password: password,
                    localCartItems: localCartItems // Pass local cart to the backend
                })
                // -------------------------------------------------------
            });

            // 3. Robust JSON Parsing
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                throw new Error(`Server Error (${response.status}): Could not reach login service.`);
            }

            // 4. Handle API Responses
            if (response.ok) {
                // SUCCESS (HTTP 200): Login successful

                // --- ðŸ”‘ CART MERGE LOGIC - STEP 3: CLEAR LOCAL STORAGE ---
                if (localCartItems.length > 0) {
                    localStorage.removeItem('outflickzLocalCart');
                    console.log('Local cart cleared upon successful merge.');
                }
                // ----------------------------------------------------------

                // Removed populateProfileView() call
                displayMessage('Successfully signed in! Your cart was merged. Redirecting to homepage...', 'success');

                setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'homepage.html'; // Actual redirect activated
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // console.log('Login successful - would redirect now.'); // Optional: Remove the log if redirecting
Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);

            } else if (response.status === 403 && data.needsVerification) {
                // FAILED (HTTP 403): Account needs verification
                pendingVerificationEmail = email;
                document.getElementById('verify-email-display').textContent = email;

                displayMessage(data.message || 'Your account needs to be verified. Please enter the code sent to your email.', 'error');

                setTimeout(() => {
                    showView('verify');
                    setResendCooldown(60);
                }, 1000);

            } else if (response.status === 401) {
                // FAILED (HTTP 401): Invalid credentials
                displayMessage(data.message || 'Sign In failed. Please check your email and password.', 'error');

            } else {
                // OTHER ERRORS (e.g., 500 Server Error)
                const errorMessage = data.message || `API Error (${response.status}): An unexpected error occurred.`;
                displayMessage(`Sign In Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            // 5. Handle Network/Parsing Errors
            console.error('Login network or API call failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the login service.'}`, 'error');
        } finally {
            // 6. Reset button state
            loginBtn.textContent = 'Sign In';
            loginBtn.disabled = false;
        }
    }

    /**
     * Handles create account form submission and transitions to verification view.
     */
    async function handleCreateAccount(event) {
        event.preventDefault();
        const form = event.target;
        const email = document.getElementById('create-email').value;
        const password = document.getElementById('create-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const createBtn = document.getElementById('create-btn');

        if (password !== confirmPassword) {
            displayMessage('Passwords do not match.', 'error');
            return;
        }
        if (password.length < 8) {
            displayMessage('Password must be at least 8 characters.', 'error');
            return;
        }

        createBtn.textContent = 'Creating...';
        createBtn.disabled = true;
        displayMessage('Attempting to create account via /api/register...', 'info');

        try {
            const response = await fetch(REGISTER_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    email: email,
                    password: password
                })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                        // Throwing an error here prevents the "Unexpected end of JSON input" error on 404/500
                        throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                // Success: Account created, verification code sent
                pendingVerificationEmail = email;
                document.getElementById('verify-email-display').textContent = email;

                displayMessage(`Success! Account created. Now check ${email} for your 6-digit verification code.`, 'success');

                form.reset();

                setTimeout(() => {
                    showView('verify');
                    setResendCooldown(60);
                }, 2000);

            } else {
                // Handle API errors (4xx, 5xx with JSON body)
                const errorMessage = data.message || `API Error (${response.status}): An unexpected error occurred.`;
                displayMessage(`Registration Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            // Handle network errors or the Error thrown by robust parsing
            console.error('Network or API call failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the registration service. Check endpoint configuration.'}`, 'error');
        } finally {
            createBtn.textContent = 'Create Account';
            createBtn.disabled = false;
        }
    }

    /**
     * Handles account verification code submission.
     */
    async function handleVerification(event) {
        event.preventDefault();
        const code = document.getElementById('verify-code').value;
        const verifyBtn = document.getElementById('verify-btn');
        const email = pendingVerificationEmail;

        if (!email) {
            displayMessage('Error: No pending email found. Please create an account.', 'error');
            showView('create');
            return;
        }

        verifyBtn.textContent = 'Verifying...';
        verifyBtn.disabled = true;

        try {
            const response = await fetch(VERIFY_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: code })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                        throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                displayMessage('Account verified successfully! You can now sign in.', 'success');

                pendingVerificationEmail = '';
                document.getElementById('verify-code').value = '';

                setTimeout(() => {
                    showView('login');
                    document.getElementById('login-email').value = email; // Pre-fill email
                }, 2000);

            } else {
                const errorMessage = data.message || `Verification API Error (${response.status}).`;
                displayMessage(`Verification Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            console.error('Verification network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the verification service.'}`, 'error');
        } finally {
            verifyBtn.textContent = 'Verify Account';
            verifyBtn.disabled = false;
        }
    }

    /**
     * Starts a cooldown timer for the Resend Code button.
     */
    function setResendCooldown(durationSeconds = 60) {
        const resendBtn = document.getElementById('resend-btn');
        resendBtn.disabled = true;
        let timer = durationSeconds;
        resendBtn.textContent = `Resend Code (${timer}s)`;

        const interval = setInterval(() => {
            timer--;
            if (timer > 0) {
                resendBtn.textContent = `Resend Code (${timer}s)`;
            } else {
                clearInterval(interval);
                resendBtn.textContent = 'Resend Code';
                resendBtn.disabled = false;
            }
        }, 1000);
    }

    /**
     * Handles resending the verification code with cooldown logic.
     */
    async function handleResendCode() {
        const resendBtn = document.getElementById('resend-btn');
        const email = pendingVerificationEmail;

        if (resendBtn.disabled) {
            // Cooldown is active, just return
            return;
        }

        if (!email) {
            showView('create');
            displayMessage('Please create an account first.', 'error');
            return;
        }

        setResendCooldown(60);
        displayMessage(`Resending code to ${email}...`, 'info');

        try {
            const response = await fetch(RESEND_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                        throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING

            if (response.ok) {
                displayMessage('New code successfully sent! Check your inbox.', 'success');
            } else {
                const errorMessage = data.message || `Resend API Error (${response.status}).`;
                displayMessage(`Resend Failed: ${errorMessage}`, 'error');
            }
        } catch (error) {
            console.error('Resend network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the resend service.'}`, 'error');
        }
    }

    /**
     * Placeholder function for handling forgot password form submission.
     */
    function handleForgotPassword(event) {
        event.preventDefault();
        const email = document.getElementById('forgot-email').value;
        // In a real app, send API call to trigger password reset email
        displayMessage(`If an account exists for ${email}, a password reset link has been sent.`, 'success');
        setTimeout(() => {
            showView('login');
        }, 5000);
    }

    // handleLogout and populateProfileView functions have been removed.

</script>
</body>
</html>