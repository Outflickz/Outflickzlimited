<!DOCTYPE html>
<html lang="en" class="text-[90%] sm:text-[95%] md:text-[100%]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Outflickz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script> 
    <style>
        /* Load Inter (main font) and Playfair Display (for "OUTFLICKZ" logo) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');

        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hide number input arrows/spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }

        /* Custom styles for the message modal */
        #message-modal-container {
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black overlay */
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
        }
        #message-modal-container.hidden .modal-content {
            transform: translateY(-50px);
        }
        
        /* Step indicator styling */
        .step-active {
            @apply bg-ash-red text-white;
        }
        .step-inactive {
            @apply bg-gray-200 text-gray-500;
        }
        .step-complete {
            @apply bg-green-500 text-white;
        }
    </style>
</head>
<body class="bg-gray-50 text-color-black min-h-screen">

    <div id="message-modal-container" class="fixed inset-0 z-[100] hidden flex justify-center items-start pt-10" role="alert" aria-live="assertive">
        <div class="modal-content bg-ash-dark text-white p-4 rounded-lg shadow-2xl max-w-sm w-full relative">
            <p id="message-modal-text" class="text-sm font-medium"></p>
            <button id="message-modal-close-btn" class="absolute top-1 right-1 text-gray-400 hover:text-white transition" aria-label="Close message">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <header class="bg-color-white sticky top-0 z-50 shadow-md border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-14 sm:h-16 flex items-center justify-between">
            <a href="homepage.html" class="flex items-center" aria-label="Outflickz Home">
                <img src="https://i.imgur.com/PZLMws6.jpeg" alt="Outflickz Logo" class="w-auto h-10 sm:h-12 lg:h-10">
            </a>

            <nav class="hidden md:flex flex-grow justify-center space-x-6 lg:space-x-10 text-sm" aria-label="Main Navigation">
                <a href="homepage.html" class="font-medium text-color-black hover:text-gray-600 transition">Homepage</a>
                <a href="preorder.html" class="font-medium text-color-black hover:text-gray-600 transition">Pre Order</a>
                <a href="newarrivals.html" class="font-medium text-color-black hover:text-gray-600 transition">New Arrivals</a>
                <a href="wearscollection.html" class="font-medium text-color-black hover:text-gray-600 transition flex items-center">Wears Collections</a>
                <a href="capcollection.html" class="font-medium text-color-black hover:text-gray-600 transition flex items-center">Cap Collections</a>
            </nav>

            <div class="flex items-center space-x-2 sm:space-x-4">
                <button id="profile-icon" 
                class="p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full hidden md:block" 
                aria-label="User Account"
                onclick="redirectToProfileOrLogin()">
                    <i class="fas fa-user w-4 h-4 sm:w-5 sm:h-5"></i>
                </button>
                <a href="cart.html" class="relative p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full" aria-label="Shopping Bag">
                    <i class="fas fa-shopping-bag w-4 h-4 sm:w-5 sm:h-5"></i>
                    <span id="cart-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-ash-red rounded-full hidden">
                        0
                    </span>
                </a>
                <button class="md:hidden p-1 sm:p-2 text-gray-700 hover:text-ash-dark transition rounded-full" onclick="toggleMenu()" aria-expanded="false" aria-controls="mobile-menu" aria-label="Open main menu">
                    <i class="fas fa-bars w-5 h-5 sm:w-6 sm:h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <div id="mobile-menu" class="hidden md:hidden bg-color-white border-b border-gray-100 absolute w-full z-40 shadow-lg">
        <div class="px-2 pt-2 pb-3 space-y-1 text-sm">
            <a href="homepage.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Homepage</a>
            <a href="preorder.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Pre Order</a>
            <a href="newarrivals.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">New Arrivals</a>
            <a href="wearscollection.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Wears Collection</a>
            <a href="capcollection.html" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Cap Collection</a>
            <a href="javascript:void(0);" onclick="redirectToProfileOrLogin()" class="block px-3 py-2 font-medium text-gray-700 hover:bg-gray-100 rounded-md">Account</a>
        </div>
    </div>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-12">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-ash-dark mb-8 uppercase tracking-wide">
            ðŸ’³ Secure Checkout
        </h1>

        <div class="flex justify-between items-center mb-10 text-center relative">
            <div class="absolute inset-x-0 top-3 h-0.5 bg-gray-200 z-0"></div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-1" class="step-indicator step-active w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">1</div>
                <span class="text-xs sm:text-sm text-ash-dark font-medium">Shipping Info</span>
            </div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-2" class="step-indicator step-inactive w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">2</div>
                <span class="text-xs sm:text-sm text-gray-500">Review Order</span>
            </div>
            
            <div class="flex-1 z-10">
                <div id="step-indicator-3" class="step-indicator step-inactive w-8 h-8 rounded-full flex items-center justify-center mx-auto mb-1 text-sm font-bold">3</div>
                <span class="text-xs sm:text-sm text-gray-500">Payment</span>
            </div>
        </div> 
        
        <div class="lg:grid lg:grid-cols-3 lg:gap-10">
            
            <div class="lg:col-span-2 space-y-8">
                
                <section id="shipping-info-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">1. Contact & Shipping Information</h2>
                    <form id="shipping-form" onsubmit="event.preventDefault(); validateAndProceedToReview();">
                        <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-6">
                            <div class="sm:col-span-2">
                                <label for="email" class="block text-sm font-medium text-gray-700">Email address (for confirmations) <span class="text-ash-red">*</span></label>
                                <input type="email" id="email" name="email" autocomplete="email" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red" placeholder="e.g., john.doe@example.com">
                            </div>
                            
                            <div class="sm:col-span-2">
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (for delivery) <span class="text-ash-red">*</span></label>
                                <input type="tel" id="phone" name="phone" autocomplete="tel" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red" placeholder="e.g., +2348012345678">
                            </div>

                            <div class="sm:col-span-2 border-t border-gray-200 pt-6 mt-6">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3">Shipping Details</h3>
                            </div>

                            <div>
                                <label for="first-name" class="block text-sm font-medium text-gray-700">First name <span class="text-ash-red">*</span></label>
                                <input type="text" id="first-name" name="first-name" autocomplete="given-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="last-name" class="block text-sm font-medium text-gray-700">Last name <span class="text-ash-red">*</span></label>
                                <input type="text" id="last-name" name="last-name" autocomplete="family-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div class="sm:col-span-2">
                                <label for="address-line-1" class="block text-sm font-medium text-gray-700">Street address <span class="text-ash-red">*</span></label>
                                <input type="text" id="address-line-1" name="address-line-1" autocomplete="street-address" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="city" class="block text-sm font-medium text-gray-700">City <span class="text-ash-red">*</span></label>
                                <input type="text" id="city" name="city" autocomplete="address-level2" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="state" class="block text-sm font-medium text-gray-700">State / Province <span class="text-ash-red">*</span></label>
                                <input type="text" id="state" name="state" autocomplete="address-level1" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="zip-code" class="block text-sm font-medium text-gray-700">ZIP / Postal code</label>
                                <input type="text" id="zip-code" name="zip-code" autocomplete="postal-code" class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                            </div>
                            <div>
                                <label for="country" class="block text-sm font-medium text-gray-700">Country <span class="text-ash-red">*</span></label>
                                <select id="country" name="country" autocomplete="country-name" required class="mt-1 block w-full border border-gray-300 rounded-sm shadow-sm py-2 px-3 focus:outline-none focus:ring-ash-red focus:border-ash-red">
                                    <option value="Nigeria">Nigeria</option>
                                    <option value="Ghana">Ghana</option>
                                    </select>
                            </div>
                        </div>
                    </form>
                </section>

                <section id="review-order-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100 hidden">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">2. Review & Confirm</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">Shipping Address</h3>
                                <button onclick="checkoutStep = 1; updateCheckoutView();" class="text-sm font-medium text-ash-red hover:text-red-700">Change</button>
                            </div>
                            <div class="text-sm text-gray-700 p-4 bg-gray-50 rounded-md border">
                                <p id="review-address-name" class="font-medium"></p>
                                <p id="review-address-line1"></p>
                                <p id="review-address-line2"></p>
                                <p id="review-contact-info" class="mt-2 text-gray-500"></p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Items in Order</h3>
                            <div id="review-items-list" class="divide-y divide-gray-100 border border-gray-200 rounded-md p-2">
                                </div>
                        </div>
                    </div>
                </section>

                <section id="payment-section" class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-gray-100 hidden">
                    <h2 class="text-2xl font-bold text-ash-dark mb-6 border-b pb-4">3. Payment</h2>
                    
                    <div class="space-y-6">
                        <p class="text-gray-700">Please select your preferred payment method:</p>

                        <div class="space-y-4">
                            <div class="relative flex items-start border border-gray-300 rounded-md p-4 transition-all focus-within:ring-2 focus-within:ring-ash-red">
                                <div class="flex items-center h-5">
                                    <input id="payment-paystack" name="payment-method" type="radio" value="Paystack/Card" checked class="focus:ring-ash-red h-4 w-4 text-ash-red border-gray-300">
                                </div>
                                <div class="ml-3 text-sm flex-1">
                                    <label for="payment-paystack" class="font-medium text-gray-900 flex justify-between items-center">
                                        Card Payment (Paystack)
                                        <img src="https://i.imgur.com/fuT8ucM.png" alt="Paystack" class="h-5">
                                    </label>
                                    <p id="paystack-description" class="text-gray-500">Pay securely with your Visa, MasterCard, or Verve card.</p>
                                </div>
                            </div>

                            <div class="relative flex items-start border border-gray-300 rounded-md p-4 transition-all focus-within:ring-2 focus-within:ring-ash-red">
                                <div class="flex items-center h-5">
                                    <input id="payment-bank" name="payment-method" type="radio" value="Bank Transfer" class="focus:ring-ash-red h-4 w-4 text-ash-red border-gray-300">
                                </div>
                                <div class="ml-3 text-sm flex-1">
                                    <label for="payment-bank" class="font-medium text-gray-900">
                                        Direct Bank Transfer (Manual)
                                    </label>
                                    <p id="bank-description" class="text-gray-500">View details, make the transfer, and upload your receipt below.</p>
                                    
                                    <div id="bank-details-info" class="mt-3 p-3 bg-gray-100 rounded-md border border-gray-200" style="display:none;">
                                        <h4 class="font-bold text-ash-dark mb-1">Outflickz Account Details:</h4>
                                        <p class="text-xs">
                                            **Bank Name:** Opay<br>
                                            **Account Name:** Outflickz limited<br>
                                            **Account Number:** 8149747864
                                        </p>
                                        <p class="text-xs text-ash-red mt-2">
                                            **IMPORTANT:** Transfer the **â‚¦<span id="summary-estimated-total-bank">0.00</span>** total.
                                        </p>
                                        
                                        <div class="mt-4 pt-3 border-t border-gray-200">
                                            <label for="payment-receipt" class="block text-sm font-medium text-gray-700 mb-1">Upload Payment Receipt <span class="text-ash-red">*</span></label>
                                            <input type="file" id="payment-receipt" name="payment-receipt" accept="image/*, .pdf" class="block w-full text-sm text-gray-500
                                                file:mr-4 file:py-2 file:px-4
                                                file:rounded-full file:border-0
                                                file:text-sm file:font-semibold
                                                file:bg-ash-red/10 file:text-ash-red
                                                hover:file:bg-ash-red/20"
                                            >
                                            <p class="text-xs text-gray-400 mt-1">Accepted formats: JPG, PNG, PDF.</p>
                                        </div>
                                        </div>
                                </div>
                            </div>
                        
                            <div class="mt-6 border-t border-gray-200 pt-4">
                                <div class="flex justify-between items-center">
                                    <p class="text-lg font-bold text-ash-dark">Total Due Now</p>
                                    <p id="final-total-due" class="text-2xl font-extrabold text-ash-red" data-total-amount="0">â‚¦<span id="summary-estimated-total-final">0.00</span></p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">By clicking "Confirm & Pay Now", you agree to our Terms of Use.</p>
                            </div>
                        </div>
                    </div>
                </section>
                
                <div class="pt-6 border-t border-gray-200">
                    <button id="checkout-next-btn" class="w-full bg-ash-red text-white hover:bg-red-700 transition duration-300 font-semibold py-4 rounded-sm shadow-lg uppercase tracking-widest text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span id="checkout-btn-text">Continue to Review</span>
                    </button>
                    <a href="cart.html" class="mt-4 block text-center text-sm font-medium text-gray-600 hover:text-ash-red transition">
                        &leftarrow; Return to Cart
                    </a>
                </div>

            </div>
            
            <div class="mt-8 lg:mt-0 lg:col-span-1">
                <div class="bg-color-white p-6 rounded-lg shadow-xl border border-gray-100 lg:sticky lg:top-20">
                    <h2 class="text-xl font-bold text-ash-dark mb-6">Order Summary</h2>

                    <div class="space-y-4">
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Subtotal (Items)</span>
                            <span id="summary-subtotal" class="font-semibold">â‚¦0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700">
                            <span>Shipping</span>
                            <span id="summary-shipping-cost" class="font-semibold">â‚¦0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-700 border-t border-gray-200 pt-4">
                            <span>Tax Estimate (0%)</span>
                            <span id="summary-tax-estimate" class="font-semibold">â‚¦0.00</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-300 pt-4 mt-6 flex justify-between items-center">
                        <p class="text-lg font-bold text-ash-dark">Estimated Total</p>
                        <p id="summary-estimated-total" class="text-xl font-extrabold text-ash-red">â‚¦0.00</p>
                    </div>

                    <p class="text-xs text-gray-500 mt-2 text-right">Final price includes all duties and fees.</p>

                    <div class="mt-6 border-t border-gray-100 pt-6">
                        <h3 class="text-sm font-semibold text-ash-dark mb-3">Guaranteed Security</h3>
                        <div class="flex items-center text-sm text-gray-700 space-x-4">
                            <i class="fas fa-lock text-lg text-green-600"></i>
                            <p>All transactions are secured by **Paystack**.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
    
    <footer class="bg-gray-900 text-gray-300 py-10 sm:py-14 border-t border-gray-800 mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-8">
                
                <div class="col-span-2 lg:col-span-1">
                    <a href="homepage.html" class="flex items-center mb-4">
                        <img src="https://i.imgur.com/PZLMws6.jpeg" alt="Outflickz Logo" class="w-auto h-8 filter grayscale invert">
                    </a>
                    <p class="text-sm text-gray-500">
                        The home of exclusive street wear and limited edition drops. Elevate your style.
                    </p>
                    <div class="flex space-x-4 mt-4 text-gray-400">
                        <a href="#" aria-label="Instagram" class="hover:text-ash-red transition"><i class="fab fa-instagram"></i></a>
                        <a href="#" aria-label="Twitter" class="hover:text-ash-red transition"><i class="fab fa-twitter"></i></a>
                        <a href="#" aria-label="Facebook" class="hover:text-ash-red transition"><i class="fab fa-facebook-f"></i></a>
                    </div>
                </div>

                <div class="col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="wearscollection.html" class="text-gray-400 hover:text-ash-red transition">Wears</a></li>
                        <li><a href="capcollection.html" class="text-gray-400 hover:text-ash-red transition">Caps</a></li>
                        <li><a href="newarrivals.html" class="text-gray-400 hover:text-ash-red transition">New Arrivals</a></li>
                        <li><a href="preorder.html" class="text-gray-400 hover:text-ash-red transition">Pre-Order</a></li>
                    </ul>
                </div>

                <div class="col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Customer Care</h3>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Contact Us</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Shipping & Returns</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">FAQ</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-ash-red transition">Size Guide</a></li>
                    </ul>
                </div>

                <div class="col-span-2 md:col-span-1">
                    <h3 class="text-sm font-semibold uppercase tracking-wider text-white mb-4">Get In Touch</h3>
                    <address class="text-sm not-italic space-y-2">
                        <p class="text-gray-400">
                            <i class="fas fa-map-marker-alt mr-2 text-ash-red"></i> 123 Streetwear Ave, City, Country
                        </p>
                        <p class="text-gray-400">
                            <i class="fas fa-envelope mr-2 text-ash-red"></i> support@outflickz.com
                        </p>
                        <p class="text-gray-400">
                            <i class="fas fa-phone mr-2 text-ash-red"></i> +1 (555) 123-4567
                        </p>
                    </address>
                </div>
            </div>

            <div class="border-t border-gray-800 mt-10 pt-6">
                <p class="text-center text-xs text-gray-500">
                    &copy; 2025 Outflickz. All rights reserved. | <a href="#" class="hover:text-ash-red">Privacy Policy</a> | <a href="#" class="hover:text-ash-red">Terms of Use</a>
                </p>
            </div>
        </div>
    </footer>
    
    <a href="https://wa.me/2347042882706?text=HELLO!%20WELCOME%20TO%20OUTFLICKZ!%20HOW%20CAN%20WE%20HELP%20YOU" 
        target="_blank" 
        class="fixed bottom-6 right-6 z-50 bg-[#25D366] text-white p-3 sm:p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105" 
        aria-label="Chat with us on WhatsApp">
        <i class="fab fa-whatsapp text-2xl sm:text-3xl"></i>
    </a>

    <script>
        // Customizing Tailwind colors to match the theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ash-dark': '#111111',
                        'ash-red': '#a80000',
                        'color-white': '#FFFFFF',
                        'color-black': '#000000',
                        'racing-grey': '#333333',
                        'racing-silver': '#AAAAAA',
                    }
                }
            }
        }
    
        // Global Constants (Reused from cart.html)
        const CART_STORAGE_KEY = 'outflickzCartCount';
        const LOCAL_CART_KEY = 'outflickzLocalCart';
        const API_BASE_URL = 'https://outflickz.netlify.app'; // Assuming this is your base path

        // --- PAYSTACK CONSTANTS ---
        const PAYSTACK_PUBLIC_KEY = 'pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; // <<< REPLACE THIS WITH YOUR ACTUAL PUBLIC KEY!
        const CURRENCY_CODE = 'NGN'; // Nigerian Naira
        const DEFAULT_ADMIN_EMAIL="outflickzlimited@gmail.com"

        // --- MESSAGE & MODAL DISPLAY FUNCTION (Reused) ---
        function displayMessage(message) {
            const modalContainer = document.getElementById('message-modal-container');
            const modalText = document.getElementById('message-modal-text');

            if (modalContainer && modalText) {
                modalText.textContent = message;
                modalContainer.classList.remove('hidden');

                modalContainer.onclick = (e) => {
                    if (e.target === modalContainer) {
                        hideMessageModal();
                    }
                };

                setTimeout(hideMessageModal, 4000);
            } else {
                console.warn("Modal elements not found. Message:", message);
            }
        }

        function hideMessageModal() {
            const modalContainer = document.getElementById('message-modal-container');
            if (modalContainer) {
                modalContainer.classList.add('hidden');
                modalContainer.onclick = null;
            }
        }

        // --- USER AUTHENTICATION & REDIRECTION FUNCTIONS (Reused) ---
        function isUserLoggedIn() {
            return localStorage.getItem('outflickzAuthStatus') === 'loggedIn';
        }

        function redirectToProfileOrLogin() {
            if (isUserLoggedIn()) {
                window.location.href = 'userprofile.html';
            } else {
                window.location.href = 'useraccount.html';
            }
        }
        
        function updateCartBadge() {
            const badge = document.getElementById('cart-badge');
            if (!badge) return;
            const count = parseInt(localStorage.getItem(CART_STORAGE_KEY) || '0');
            
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // --- NEW: FETCH USER DATA TO PRE-FILL FORM ---
        async function fetchUserData() {
            if (!isUserLoggedIn()) {
                return;
            }

            try {
                // Assuming your backend has an endpoint to get the logged-in user's profile/address
                const response = await fetch('/api/users/account', {
                    method: 'GET',
                    // Include Authorization header if needed by your API
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch user data. Please log in again.');
                }

                const userData = await response.json();
                // Expected userData structure: { firstName, lastName, email, phone, address: { street, city, state, zipCode, country } }

                // Pre-fill Contact Info
                document.getElementById('email').value = userData.email || '';

                // Pre-fill Shipping Info (if available)
                if (userData.firstName) document.getElementById('first-name').value = userData.firstName;
                if (userData.lastName) document.getElementById('last-name').value = userData.lastName;

                if (userData.address) {
                    const address = userData.address;
                    if (address.street) document.getElementById('address-line-1').value = address.street;
                    if (address.city) document.getElementById('city').value = address.city;
                    if (address.state) document.getElementById('state').value = address.state;
                    if (address.zipCode) document.getElementById('zip-code').value = address.zipCode;
                    if (address.country) document.getElementById('country').value = address.country;
                }
                
                // Save to local storage for use in the review step (Step 2)
                localStorage.setItem('outflickzShippingData', JSON.stringify({
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    email: userData.email,
                    street: userData.address?.street,
                    city: userData.address?.city,
                    state: userData.address?.state,
                    zipCode: userData.address?.zipCode,
                    country: userData.address?.country
                }));
            } catch (error) {
                console.error('Error fetching user data:', error);
                displayMessage('Could not load saved address. Please enter manually.');
            }
        }


        // ---------------------------------------------------
        // --- CHECKOUT LOGIC ---
        // ---------------------------------------------------

        let checkoutStep = 1; // 1: Info, 2: Review, 3: Payment
        const STEPS = [
            { id: 1, name: 'Shipping Info', sectionId: 'shipping-info-section' },
            { id: 2, name: 'Review Order', sectionId: 'review-order-section' },
            { id: 3, name: 'Payment', sectionId: 'payment-section' }
        ];

        /**
         * Renders the correct step content and updates the step indicators.
         */
        function updateCheckoutView() {
            // 1. Update Step Indicators
            STEPS.forEach(step => {
                const indicator = document.getElementById(`step-indicator-${step.id}`);
                const section = document.getElementById(step.sectionId);
                
                section.classList.add('hidden'); // Hide all sections initially

                if (step.id < checkoutStep) {
                    indicator.className = 'step-indicator step-complete';
                    indicator.innerHTML = '<i class="fas fa-check"></i>';
                } else if (step.id === checkoutStep) {
                    indicator.className = 'step-indicator step-active';
                    indicator.textContent = step.id;
                    section.classList.remove('hidden'); // Show current section
                } else {
                    indicator.className = 'step-indicator step-inactive';
                    indicator.textContent = step.id;
                }
            });
            
            // 2. Update button text/action based on the step
            const nextBtn = document.getElementById('checkout-next-btn');
            const btnText = document.getElementById('checkout-btn-text');
            
            if (checkoutStep === 1) {
                btnText.textContent = 'Continue to Review';
                nextBtn.onclick = validateAndProceedToReview;
            } else if (checkoutStep === 2) {
                btnText.textContent = 'Proceed to Payment';
                nextBtn.onclick = proceedToPayment;
            } else if (checkoutStep === 3) {
                btnText.textContent = 'Confirm & Pay Now';
                nextBtn.onclick = handleFinalOrderPlacement;
            }
        }

        /**
        * Validates shipping form data and moves to Step 2 (Review).
        */
        function validateAndProceedToReview() {
            const form = document.getElementById('shipping-form');
            const zipCodeEl = document.getElementById('zip-code');
            
            // NOTE: Since phone is crucial for delivery and ZIP is optional in some countries,
            // we manually check required fields.
            
            // Temporarily remove 'required' from 'zip-code' if it exists for this check
            const isZipRequired = zipCodeEl.hasAttribute('required');
            if (isZipRequired) zipCodeEl.removeAttribute('required');

            if (!form.checkValidity()) {
                // Re-add 'required' if we removed it before showing the error
                if (isZipRequired) zipCodeEl.setAttribute('required', '');
                
                form.reportValidity();
                displayMessage('Please fill out all required shipping fields.');
                return;
            }
            
            // Re-add 'required' if we removed it, now that validation has passed
            if (isZipRequired) zipCodeEl.setAttribute('required', '');


            // Capture the data
            const shippingData = {
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                email: document.getElementById('email').value,
                street: document.getElementById('address-line-1').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zipCode: document.getElementById('zip-code').value, // Optional data is still captured
                country: document.getElementById('country').value,
            };
            localStorage.setItem('outflickzShippingData', JSON.stringify(shippingData));

            // Update the review section with the data
            document.getElementById('review-address-name').textContent = `${shippingData.firstName} ${shippingData.lastName}`;
            document.getElementById('review-address-line1').textContent = shippingData.street;
            
            // Use optional chaining/nullish coalescing for zipCode in case it's empty
            const reviewZipCode = shippingData.zipCode ? `, ${shippingData.zipCode}` : '';
            document.getElementById('review-address-line2').textContent = `${shippingData.city}, ${shippingData.state}${reviewZipCode}, ${shippingData.country}`;
            
            // Update contact info display to include phone
            document.getElementById('review-contact-info').textContent = `${shippingData.email}`;

            checkoutStep = 2;
            updateCheckoutView();
            window.scrollTo(0, 0); // Scroll to top for new section
        }

        /**
         * Moves to Step 3 (Payment).
         */
        function proceedToPayment() {
            checkoutStep = 3;
            updateCheckoutView();
            window.scrollTo(0, 0); // Scroll to top for new section

            // Also update the bank transfer total display (for user convenience)
            const finalTotalText = document.getElementById('summary-estimated-total-final').textContent;
            document.getElementById('summary-estimated-total-bank').textContent = finalTotalText;
        }

        /**
         * Fetches the initial cart data from the backend API.
         */
        async function fetchInitialCartData() {
            const currencySymbol = 'â‚¦'; // Assuming 'â‚¦' is the correct currency symbol
            const subtotalEl = document.getElementById('summary-subtotal');
            const shippingCostEl = document.getElementById('summary-shipping-cost');
            const taxEstimateEl = document.getElementById('summary-tax-estimate');
            const estimatedTotalEl = document.getElementById('summary-estimated-total');
            const finalTotalEl = document.getElementById('summary-estimated-total-final'); // Added for step 3
            const itemsListEl = document.getElementById('review-items-list');
            const paymentBtn = document.getElementById('checkout-next-btn');
            
            // Set loading state
            subtotalEl.textContent = '...';
            shippingCostEl.textContent = '...';
            taxEstimateEl.textContent = '...';
            estimatedTotalEl.textContent = '...';
            finalTotalEl.textContent = '...'; 
            document.getElementById('summary-estimated-total-bank').textContent = '...'; // NEW: Bank display
            itemsListEl.innerHTML = '<div class="text-center py-6 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Loading cart data...</div>';
            paymentBtn.disabled = true;

            // Simple cart check before API call
            if (localStorage.getItem(CART_STORAGE_KEY) === '0' || !localStorage.getItem(LOCAL_CART_KEY)) {
                displayMessage('Your cart is empty. Redirecting to home.');
                setTimeout(() => window.location.href = 'homepage.html', 1500);
                return;
            }

            try {
                // === REAL API CALL START (Placeholder) ===
                // This call is crucial as it should calculate the *final* total based on server-side logic (stock, shipping rates, etc.)
                const response = await fetch('/api/checkout/cart-summary', { // Changed endpoint name for clarity
                    method: 'GET',
                    // Add headers/auth tokens as needed
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'API error.' }));
                    throw new Error(errorData.message || 'Failed to fetch cart data from API.');
                }

                const cartData = await response.json();
                /* cartData structure is expected to be:
                { 
                    items: [{name, size, color, quantity, price, imageUrl}], 
                    subtotal: 32000.00, 
                    shipping: 2500.00, 
                    tax: 0.00, 
                    estimatedTotal: 34500.00 
                } */
                // === REAL API CALL END ===

                if (cartData.items.length === 0) {
                    displayMessage('Your cart is empty. Redirecting to home.');
                    setTimeout(() => window.location.href = 'homepage.html', 1500);
                    return;
                }
                
                // Render Summary
                const subtotal = cartData.subtotal || 0;
                const shipping = cartData.shipping || 0;
                const tax = cartData.tax || 0;
                const total = cartData.estimatedTotal || (subtotal + shipping + tax);

                subtotalEl.textContent = `${currencySymbol}${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                shippingCostEl.textContent = `${currencySymbol}${shipping.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                taxEstimateEl.textContent = `${currencySymbol}${tax.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                estimatedTotalEl.textContent = `${currencySymbol}${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                finalTotalEl.textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2 }); // For Step 3
                document.getElementById('summary-estimated-total-bank').textContent = total.toLocaleString(undefined, { minimumFractionDigits: 2 }); // NEW: Bank display

                // Render Review Items List
                itemsListEl.innerHTML = cartData.items.map(item => `
                    <div class="flex justify-between items-start py-2">
                        <div class="flex items-center">
                            <img src="${item.imageUrl}" alt="${item.name}" class="w-10 h-10 rounded-md border mr-3">
                            <div class="text-sm">
                                <p class="font-medium text-gray-900">${item.name}</p>
                                <p class="text-xs text-gray-500">${item.size} / ${item.color} (Qty: ${item.quantity})</p>
                            </div>
                        </div>
                        <span class="text-sm font-semibold text-gray-900">${currencySymbol}${(item.price * item.quantity).toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                    </div>
                `).join('');

                // Store the final total for payment simulation
                localStorage.setItem('outflickzOrderTotal', total.toFixed(2));

                // Enable button
                paymentBtn.disabled = false;
                
            } catch (error) {
                console.error('Error fetching cart data for checkout:', error);
                itemsListEl.innerHTML = '<div class="text-center py-6 text-red-500">Error loading cart. Please go back to cart.</div>';
                displayMessage(error.message || 'An error occurred loading your cart. Please try again.');
                paymentBtn.disabled = true;
            }
        }


        /**
         * Handles the final step: Payment confirmation and order creation.
         */
        async function handleFinalOrderPlacement() {
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked');
            if (!paymentMethod) {
                displayMessage('Please select a payment method.');
                return;
            }

            const totalAmount = parseFloat(localStorage.getItem('outflickzOrderTotal') || 0);
            const shippingAddress = JSON.parse(localStorage.getItem('outflickzShippingData'));
            const email = shippingAddress?.email;

            if (totalAmount <= 0 || !shippingAddress || !email) {
                displayMessage('Order or contact data missing. Please refresh and try again.');
                return;
            }

            // Disable button to prevent double submission
            const payBtn = document.getElementById('checkout-next-btn');
            payBtn.disabled = true;
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Initializing Payment...';

            if (paymentMethod.value === 'Paystack/Card') {
                // --- PAYSTACK INITIATION ---
                // ... (Paystack Pop-up logic remains the same) ...
                
                const reference = `outflickz_${Date.now()}`;
                
                if (typeof PaystackPop === 'undefined') {
                    displayMessage('Paystack script not loaded. Please check your internet connection and page HTML.');
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
                    return;
                }

                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: email,
                    amount: totalAmount * 100, // Paystack expects amount in Kobo
                    ref: reference,
                    currency: CURRENCY_CODE,
                    
                    callback: function(response){
                        displayMessage('Payment successful! Finalizing order on the server...');
                        // The server needs to handle verification and clear the cart/send admin email
                        window.location.href = `orderconfirmation.html?ref=${response.reference}&method=paystack`;
                    },
                    
                    onClose: function(){
                        displayMessage('Payment cancelled or abandoned. Please try again.');
                        payBtn.disabled = false;
                        payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
                    }
                });
                
                handler.openIframe();
                return; 

            } else if (paymentMethod.value === 'Bank Transfer') {
                // --- BANK TRANSFER (PENDING ORDER) INITIATION with FILE UPLOAD ---
                
                const receiptFile = document.getElementById('payment-receipt').files[0];

                // **NEW VALIDATION: Check for receipt upload**
                if (!receiptFile) {
                    displayMessage('Please upload your bank transfer receipt image.');
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
                    return;
                }
                
                payBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading Receipt & Placing Order...';

                // 1. Create FormData object to send file and JSON data
                const formData = new FormData();
                formData.append('paymentReceipt', receiptFile);
                formData.append('shippingAddress', JSON.stringify(shippingAddress));
                formData.append('paymentMethod', paymentMethod.value);
                formData.append('totalAmount', totalAmount);
                formData.append('adminEmail', DEFAULT_ADMIN_EMAIL); // Passed for server-side email trigger

                try {
                    // REAL FETCH: Create a pending order on the server with file upload
                    // NOTE: When sending FormData, explicitly setting the 'Content-Type' header can break the upload. 
                    // The browser sets the correct 'Content-Type: multipart/form-data'.
                    const response = await fetch('/api/orders/place/pending', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    const isSuccess = response.ok; 

                    if (isSuccess && data.orderId) {
                        // Success: The server should have saved the receipt and sent the admin email.
                        displayMessage(`Pending Order #${data.orderId} created! Admin notified. Redirecting...`);
                        
                        // Clear local storage items only if the order was successfully created on the server
                        localStorage.removeItem(LOCAL_CART_KEY);
                        localStorage.setItem(CART_STORAGE_KEY, '0');
                        localStorage.removeItem('outflickzOrderTotal');
                        updateCartBadge();

                        setTimeout(() => {
                            window.location.href = `orderconfirmation.html?id=${data.orderId}&method=banktransfer`;
                        }, 3000);

                    } else {
                        throw new Error(data.message || 'Failed to create pending order. Check server.');
                    }

                } catch (error) {
                    console.error('Pending order placement error:', error);
                    displayMessage(error.message || 'A network error occurred during receipt upload/order placement. Please try again.');
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
                }
                
            } else {
                // Fallback for other payment methods if needed
                displayMessage(`Payment method ${paymentMethod.value} selected, but not yet implemented.`);
                payBtn.disabled = false;
                payBtn.innerHTML = '<span id="checkout-btn-text">Confirm & Pay Now</span>';
            }
        }

        // --- Main Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial checks and data loading
            updateCartBadge();
            fetchInitialCartData();
            updateCheckoutView(); // Initialize step 1 view
            fetchUserData(); // NEW: Pre-fill user data if logged in

            // Attach the hideMessageModal function to the close button
            const closeButton = document.getElementById('message-modal-close-btn');
            if (closeButton) {
                closeButton.addEventListener('click', hideMessageModal);
            }

            // --- Bank Details Toggle Initialization ---
            const bankRadio = document.getElementById('payment-bank');
            const paystackRadio = document.getElementById('payment-paystack');
            const bankDetails = document.getElementById('bank-details-info');

            function toggleBankDetails() {
                if (bankDetails) {
                    // Check if the bank radio button exists and is checked
                    const isBankChecked = bankRadio && bankRadio.checked;
                    bankDetails.style.display = isBankChecked ? 'block' : 'none';
                }
            }

            if (bankRadio) bankRadio.addEventListener('change', toggleBankDetails);
            if (paystackRadio) paystackRadio.addEventListener('change', toggleBankDetails);

            // Initial check in case bank transfer is the default selected option
            toggleBankDetails(); 
        });
    </script>
</body>
</html>