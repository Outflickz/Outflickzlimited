<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Newsletter Management - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #05744b; /* emerald-700 */
            border-radius: 4px;
        }
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
        }
        /* Style for the active navigation button */
        .active-link {
            background-color: #059669; /* emerald-600 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-emerald-900 text-white transform transition-transform duration-300 z-30 lg:translate-x-0 -translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 flex-shrink-0">
            <img src="https://i.imgur.com/Fz9w1BA.png" alt="E-commerce Logo" class="h-10 w-auto mb-6 rounded-lg shadow-md border border-emerald-700">
            <h1 class="text-xl font-extrabold text-emerald-400 border-t border-emerald-800 pt-4">Commerce Hub</h1>
        </div>
        
        <nav class="space-y-2 px-4 flex-grow overflow-y-auto">
            <button id="btn-dashboard" onclick="navigateToDashboard()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l-7-7-7 7m10 0v10a1 1 0 01-1 1h-3m-3 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-9 0h10"></path></svg>
                Dashboard
            </button>
            
            <button id="btn-userorders" onclick="navigateToUserOrders()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                User Orders
            </button>

            <button id="btn-wearscollection" onclick="navigateToWearsCollection()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                Wears Collection
            </button>

            <button id="btn-capscollection" onclick="navigateToCapsCollection()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13h10M4 19v-6a3 3 0 013-3h10a3 3 0 013 3v6a3 3 0 01-3 3H7a3 3 0 01-3-3z"></path></svg>
                Caps Collection
            </button>
            
            <button id="btn-newarrivals" onclick="navigateToNewArrivals()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                New Arrivals
            </button>
            
            <button id="btn-preorders" onclick="navigateToPreOrders()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Pre-Order 
            </button>
            
            <button id="btn-membership" onclick="navigateToMembership()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3v-5a2 2 0 00-2-2H5a2 2 0 00-2 2v5a3 3 0 003 3z"></path></svg>
                Membership
            </button>

            <button id="btn-emailnews" onclick="navigateToEmailNews()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out bg-emerald-600 hover:bg-emerald-700 active-link">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                Email News
            </button>

            <button id="btn-settings" onclick="navigateToSettings()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.526.34.813.486 1.066-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </button>
        </nav>
        
        <div class="p-4 flex-shrink-0 border-t border-emerald-800">
            <button id="btn-logout" onclick="logoutAdmin()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 text-white shadow-lg">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Log Out
            </button>
        </div>
    </aside>

    <main class="flex-1 lg:ml-64 p-4 transition-all duration-300 overflow-x-hidden">
        <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-40 p-2 bg-emerald-600 text-white rounded-lg shadow-lg hover:bg-emerald-700 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <section id="content-emailnews" class="content-section p-6 pt-16 lg:pt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Email Newsletter Management ðŸ“§</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-2 border-emerald-500">
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-xl font-medium text-gray-700">Registered Users for Newsletter</h3>
                    <span id="user-count" class="text-lg font-bold text-emerald-600">Total: 0</span>
                </div>
                
                <div id="loading-indicator" class="text-center p-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-emerald-600 inline-block"></div>
                    <p class="mt-4 text-gray-600 text-sm">Fetching registered users...</p>
                </div>

                <div id="user-table-container" class="overflow-x-auto hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Customer Name
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Email Address
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Member Since
                                </th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>

                   <div id="error-message" class="hidden p-4 mt-4 text-sm text-red-700 bg-red-100 rounded-lg">
                    Failed to load user data. Check console for details.
                </div>
            </div>

            <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border-t-2 border-emerald-500">
                <h3 class="text-xl font-medium text-gray-700 mb-4">Send a New Newsletter</h3>
                <form id="newsletter-form" class="space-y-4">
                    <div>
                        <label for="newsletter-category" class="block text-sm font-medium text-gray-700">Email Category/Purpose</label>
                        <select id="newsletter-category" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="" disabled selected>Select the email's purpose</option>
                            <option value="New Product/Collection">New Product/Collection Launch</option>
                            <option value="Pre-Order Announcement">Pre-Order Announcement</option>
                            <option value="New Caps">New Caps Alert</option>
                            <option value="New Wears">New Wears Alert</option>
                            <option value="Sale/Promotion">Sale or Promotion</option>
                            <option value="Maintenance/Upgrade">Maintenance or Upgrade Notice</option>
                            <option value="General News">General News/Update</option>
                        </select>
                    </div>
                                        <div>
                        <label for="newsletter-subject" class="block text-sm font-medium text-gray-700">Subject</label>
                        <input type="text" id="newsletter-subject" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="E.g., HUGE Summer Sale Now Live!">
                    </div>
                                        <div>
                        <label for="newsletter-body" class="block text-sm font-medium text-gray-700">Body Content (HTML Allowed)</label>
                        <textarea id="newsletter-body" rows="8" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Enter the full HTML content for your email newsletter here. **Use {{USERNAME}} to personalize the greeting.**"></textarea>
                        <p class="text-xs text-gray-500 mt-1">**Tip:** Use the placeholder <code>{{USERNAME}}</code> in the body content to insert the user's name.</p>
                    </div>
                                        <button type="submit" class="w-full py-2 px-4 bg-emerald-600 text-white font-medium rounded-lg shadow-md hover:bg-emerald-700 transition duration-200 disabled:opacity-50">
                        Send Newsletter to All Registered Users
                    </button>
                </form>
            </div>
        </section>

    </main>

    <script>
    // --- JAVASCRIPT LOGIC ---

    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const userTableBody = document.getElementById('user-table-body');
    const userCountElement = document.getElementById('user-count');
    const loadingIndicator = document.getElementById('loading-indicator');
    const userTableContainer = document.getElementById('user-table-container');
    const errorMessage = document.getElementById('error-message');
    const newsletterForm = document.getElementById('newsletter-form'); // Added

    // --- NAVIGATION FUNCTIONS (Keep same as dashboard for consistency) ---
    
    function closeSidebarOnMobile() {
        if (window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
    }

    function navigateToDashboard() {
        closeSidebarOnMobile();
        window.location.href = './admin-dashboard.html'; 
    }
    
    function navigateToUserOrders() {
        closeSidebarOnMobile();
        window.location.href = './userorders.html';
    }
    
    function navigateToWearsCollection() {
        closeSidebarOnMobile();
        window.location.href = './wearscollection.html';
    }

    function navigateToCapsCollection() {
        closeSidebarOnMobile();
        window.location.href = './capscollection.html';
    }
    
    function navigateToNewArrivals() {
        closeSidebarOnMobile();
        window.location.href = './newarrivals.html';
    }

    function navigateToPreOrders() {
        closeSidebarOnMobile();
        window.location.href = './preorders.html';
    }

    function navigateToMembership() {
        closeSidebarOnMobile();
        window.location.href = './membership.html'; 
    }

    function navigateToEmailNews() {
        // Current page, no redirect needed, but hide sidebar
        closeSidebarOnMobile();
    }
    
    function navigateToSettings() {
        closeSidebarOnMobile();
        window.location.href = './settings.html'; // Assuming settings is a separate page now
    }
    
    function logoutAdmin() {
        console.log("Logging out... Clearing admin token.");
        localStorage.removeItem('adminToken');
        window.location.href = './admin-login.html'; 
    }

    // --- EMAIL SENDING LOGIC (NEW) ---

    /**
     * Handles the form submission to send a newsletter to all registered users.
     * @param {Event} event - The form submission event.
     */
    async function sendNewsletter(event) {
        event.preventDefault();

        const token = localStorage.getItem('adminToken');
        if (!token) {
            alert("Authentication failed. Please log in again.");
            logoutAdmin();
            return;
        }

        const subject = document.getElementById('newsletter-subject').value;
        const bodyContent = document.getElementById('newsletter-body').value;
        const category = document.getElementById('newsletter-category').value; 

        if (!subject || !bodyContent || !category) {
            alert("Please fill in the subject, body, and select a category before sending.");
            return;
        }

        const button = newsletterForm.querySelector('button[type="submit"]');
        const originalText = button.textContent;
        
        button.disabled = true;
        button.textContent = 'Sending... Please wait (This may take a moment)';
        button.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
        button.classList.add('bg-blue-500'); // Change color to indicate action

        try {
            console.log(`[FRONTEND] Sending newsletter - Category: ${category}, Subject: ${subject}`);
            // API ENDPOINT: /api/admin/email/newsletter
            const response = await fetch('/api/admin/email/newsletter', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({
                    subject: subject,
                    htmlContent: bodyContent, // This is the HTML content from the textarea
                    category: category
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));

                if (response.status === 401 || response.status === 403) {
                    alert(`Unauthorized: ${errorData.message || 'Your admin session may have expired.'}`);
                    logoutAdmin();
                    return;
                }
                throw new Error(errorData.message || `Server error: ${response.status}`);
            }

            const result = await response.json();
            alert(`Newsletter dispatch initiated! \nTotal attempts: ${result.totalAttempts}\nSuccessfully sent: ${result.sentCount}\nFailed: ${result.failedCount}`);
            
            // Clear only subject, body, and reset category selection
            document.getElementById('newsletter-subject').value = '';
            document.getElementById('newsletter-body').value = '';
            document.getElementById('newsletter-category').value = '';

        } catch (error) {
            console.error('[FRONTEND] Error sending newsletter:', error);
            alert(`Failed to send newsletter: ${error.message || 'Check console for details.'}`);
        } finally {
            button.disabled = false;
            button.textContent = originalText;
            button.classList.remove('bg-blue-500');
            button.classList.add('bg-emerald-600', 'hover:bg-emerald-700'); // Restore original color
        }
    }

    // --- INITIALIZATION AND UI LOGIC ---

    document.addEventListener('DOMContentLoaded', () => {
        loadUsersForNewsletter();
        
        // **ATTACH NEWSLETTER FORM SUBMISSION HANDLER**
        newsletterForm.addEventListener('submit', sendNewsletter);
        
        // **CRITICAL MOBILE FIX:** Toggle sidebar visibility on mobile
        sidebarToggle.addEventListener('click', (event) => {
            event.stopPropagation();
            sidebar.classList.toggle('-translate-x-full');
        });

        // Close sidebar on content click/outside click on small screens
        document.querySelector('main').addEventListener('click', (event) => {
            if (!sidebar.classList.contains('-translate-x-full') && window.innerWidth < 1024) {
                sidebar.classList.add('-translate-x-full');
            }
        });
        
        // Prevent click inside sidebar from closing it (on mobile)
        sidebar.addEventListener('click', (event) => {
            event.stopPropagation();
        });
    });

    /**
     * Formats a MongoDB date string into a readable format.
     * @param {string} dateString - The date string from the database.
     * @returns {string} - Formatted date string.
     */
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString('en-US', options);
    }
    
    // --- DATA FETCHING AND RENDERING LOGIC ---

    /**
     * Fetches all registered users from the API.
     * ASSUMPTION: API endpoint is /api/admin/users/all
     */
    async function fetchAllUsers() {
        const token = localStorage.getItem('adminToken');
        
        if (!token) {
            console.error("[FRONTEND] No adminToken found. Redirecting to login for authentication.");
            window.location.href = './admin-login.html'; 
            return null;
        }

        try {
            console.log('[FRONTEND] Attempting to fetch all users from API...');
            const response = await fetch('/api/admin/users/all', { 
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                }
            });

            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    console.error('[FRONTEND] Unauthorized access. Token expired or invalid. Logging out.');
                    logoutAdmin();
                    return null;
                }
                console.error(`[FRONTEND] API call failed with status: ${response.status}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // The API returns { users: [...], count: N }
            return data.users || [];

        } catch (error) {
            console.error('[FRONTEND] Error fetching user data:', error);
            return null;
        }
    }

    /**
     * Loads and displays the user data in the table.
     */
    async function loadUsersForNewsletter() {
        loadingIndicator.classList.remove('hidden');
        userTableContainer.classList.add('hidden');
        errorMessage.classList.add('hidden');
        userTableBody.innerHTML = '';
        userCountElement.textContent = 'Total: 0';

        const users = await fetchAllUsers();

        loadingIndicator.classList.add('hidden');

        if (users === null) {
            errorMessage.classList.remove('hidden');
            return;
        }
        
        userTableContainer.classList.remove('hidden');
        userCountElement.textContent = `Total: ${users.length.toLocaleString()}`;

        if (users.length === 0) {
            userTableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No registered users found.</td></tr>';
            return;
        }

        users.forEach(user => {
            // Assuming 'isMember' and 'createdAt' exist on the User model
            const isMember = user.isMember;
            const statusBadge = isMember 
                ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">VIP Member</span>'
                : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Standard</span>';

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${user.name}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${user.email}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${statusBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(user.createdAt)}
                </td>
            `;
            userTableBody.appendChild(row);
        });
    }

    </script>
</body>
</html>