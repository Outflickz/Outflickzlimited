<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Authentication</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom transitions for views */
        .view-transition {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        .view-active {
            opacity: 1;
            transform: translateY(0);
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">

<div class="app-container bg-white shadow-2xl rounded-2xl w-full max-w-lg overflow-hidden">
    <div class="p-8 md:p-12 form-section">
        
        <div class="flex flex-col items-center mb-10">
            <h1 id="auth-header" class="text-4xl font-extrabold text-gray-900 mb-2">Welcome Back!</h1>
            <p class="text-gray-500">Sign in or create a new account.</p>
        </div>

        <div id="message-area" class="hidden mt-8 p-4 text-sm rounded-xl font-medium" role="alert" aria-live="polite">
            </div>
        <div id="auth-views" class="relative overflow-hidden w-full max-w-md mx-auto min-h-[400px]">

            <div id="login-view" class="view-transition">
                <form id="login-form">
                    <div class="mb-5">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="login-email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-5">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input type="password" id="login-password" name="password" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="button" onclick="togglePasswordVisibility('login-password')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 text-gray-500">
                                Show
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-6">
                        <a href="#" onclick="showView('forgot'); return false;" class="text-sm text-indigo-600 hover:text-indigo-500">Forgot Password?</a>
                    </div>
                    <button type="submit" id="login-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign In
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    New user? 
                    <a href="#" onclick="showView('create'); return false;" class="font-medium text-indigo-600 hover:text-indigo-500">Create an Account</a>
                </p>
            </div>

            <div id="create-view" class="view-transition">
                <form id="create-form">
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div>
                            <label for="create-first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                            <input type="text" id="create-first-name" name="firstName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="create-last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                            <input type="text" id="create-last-name" name="lastName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="mb-5">
                        <label for="create-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="create-email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-5">
                        <label for="create-password" class="block text-sm font-medium text-gray-700 mb-2">Password (min 8 chars)</label>
                        <input type="password" id="create-password" name="password" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input type="password" id="confirm-password" name="confirmPassword" required minlength="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="create-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Create Account
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Already have an account? 
                    <a href="#" onclick="showView('login'); return false;" class="font-medium text-indigo-600 hover:text-indigo-500">Sign In</a>
                </p>
            </div>

            <div id="verify-view" class="view-transition">
                <p class="text-center text-gray-700 mb-6">
                    A 6-digit verification code was sent to <strong id="verify-email-display" class="text-indigo-600"></strong>.
                </p>
                <form id="verify-form">
                    <div class="mb-5">
                        <label for="verify-code" class="block text-sm font-medium text-gray-700 mb-2">Verification Code</label>
                        <input type="text" id="verify-code" name="code" required maxlength="6" pattern="[0-9]{6}" title="6 digit code" class="w-full px-4 py-3 text-center text-xl tracking-widest border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="verify-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mb-4">
                        Verify Account
                    </button>
                    <button type="button" id="resend-btn" onclick="handleResendCode()" disabled class="w-full flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Resend Code (60s)
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    <a href="#" onclick="showView('login'); return false;" class="font-medium text-indigo-600 hover:text-indigo-500">Go back to Sign In</a>
                </p>
            </div>

            <div id="forgot-view" class="view-transition">
                <p class="text-center text-gray-700 mb-6">
                    Enter your email to receive a password reset link.
                </p>
                <form id="forgot-form">
                    <div class="mb-5">
                        <label for="forgot-email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="forgot-email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="forgot-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Reset Password
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    <a href="#" onclick="showView('login'); return false;" class="font-medium text-indigo-600 hover:text-indigo-500">Back to Sign In</a>
                </p>
            </div>
            
            </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const LOGIN_ENDPOINT = '/api/login';
    const REGISTER_ENDPOINT = '/api/register';
    const VERIFY_ENDPOINT = '/api/verify';
    const RESEND_ENDPOINT = '/api/resend-code';

    // --- State Variables ---
    let currentView = 'login';
    let pendingVerificationEmail = '';
    
    // --- DOM Elements (Initialized in DOMContentLoaded) ---
    let views = {};
    let headerElement;
    let messageArea; // Declared here
    let container;


    // --- Utility Functions ---

    /**
     * Switches the active authentication view with a fade transition.
     */
    function showView(newView) {
        if (!views[newView]) {
            console.error(`Attempted to show unknown view: ${newView}`);
            return;
        }

        // Hide all views first
        Object.keys(views).forEach(key => {
            views[key].classList.remove('view-active');
            views[key].classList.add('view-transition');
            views[key].style.position = 'absolute';
            views[key].style.zIndex = '0';
        });

        // Show the new view
        const targetView = views[newView];
        setTimeout(() => {
            targetView.classList.remove('view-transition');
            targetView.classList.add('view-active');
            targetView.style.position = 'relative';
            targetView.style.zIndex = '1';
            currentView = newView;
            
            // Update header text based on view
            if (headerElement) {
                switch(newView) {
                    case 'login':
                        headerElement.textContent = 'Welcome Back!';
                        break;
                    case 'create':
                        headerElement.textContent = 'Create Your Account';
                        break;
                    case 'verify':
                        headerElement.textContent = 'Verify Your Account';
                        break;
                    case 'forgot':
                        headerElement.textContent = 'Password Reset';
                        break;
                    // case 'profile': REMOVED
                    //     headerElement.textContent = 'User Profile';
                    //     break;
                }
            }
        }, 10); // Small delay for smooth transition initiation
    }

    /**
     * Toggles the visibility of a password field.
     */
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const type = field.getAttribute('type') === 'password' ? 'text' : 'password';
        field.setAttribute('type', type);
        // You would typically also update the button text/icon here
    }


    /**
     * Displays a message in the designated message area.
     * @param {string} message - The message content.
     * @param {'success'|'error'|'info'} type - The message type.
     */
    function displayMessage(message, type) {
        if (!messageArea) return;

        messageArea.textContent = message;
        messageArea.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-blue-100', 'text-green-800', 'text-red-800', 'text-blue-800');
        
        switch (type) {
            case 'success':
                messageArea.classList.add('bg-green-100', 'text-green-800');
                break;
            case 'error':
                messageArea.classList.add('bg-red-100', 'text-red-800');
                break;
            case 'info':
            default:
                messageArea.classList.add('bg-blue-100', 'text-blue-800');
                break;
        }

        // Clear message after 5 seconds (except for successful login which redirects)
        if (type !== 'success' || !message.includes('Redirecting')) {
            setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.textContent = '';
            }, 5000);
        }
    }


    // --- Event Handlers ---

    /**
     * Handles sign in form submission.
     */
    async function handleSignIn(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-btn');
        
        // 1. Check for local cart items (Placeholder)
        const localCartItems = JSON.parse(localStorage.getItem('outflickzLocalCart') || '[]');
        
        // 2. Disable button and show loading
        loginBtn.textContent = 'Signing In...';
        loginBtn.disabled = true;
        displayMessage(`Attempting to sign in via /api/login... ${localCartItems.length > 0 ? '(Merging cart)' : ''}`, 'info');

        try {
            const response = await fetch(LOGIN_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    // Pass cart items to the API for merging
                    localCart: localCartItems 
                })
            });

            // 3. Robust JSON Parsing
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // End Robust Parsing

            // 4. Handle API Response
            if (response.ok) {
                // SUCCESS (HTTP 200): Login successful
                
                // --- ðŸ”‘ CART MERGE LOGIC - STEP 3: CLEAR LOCAL STORAGE ---
                if (localCartItems.length > 0) {
                    localStorage.removeItem('outflickzLocalCart');
                    console.log('Local cart cleared upon successful merge.');
                }
                // ----------------------------------------------------------

                displayMessage('Successfully signed in! Your cart was merged. Redirecting to homepage...', 'success');

                // Simulate redirect after a short delay
                setTimeout(() => {
                    window.location.href = 'userprofile.html'; // Redirect to the separate profile page
                }, 1000); 

            } else if (response.status === 403 && data.needsVerification) {
                // FAILED (HTTP 403): Account needs verification
                pendingVerificationEmail = email; 
                document.getElementById('verify-email-display').textContent = email;
                
                displayMessage(data.message || 'Your account needs to be verified. Please enter the code sent to your email.', 'error');
                
                setTimeout(() => {
                    showView('verify');
                    setResendCooldown(60); 
                }, 1000);

            } else if (response.status === 401) {
                // FAILED (HTTP 401): Invalid credentials
                displayMessage(data.message || 'Sign In failed. Please check your email and password.', 'error');
                
            } else {
                // OTHER ERRORS (e.g., 500 Server Error)
                const errorMessage = data.message || `API Error (${response.status}): An unexpected error occurred.`;
                displayMessage(`Sign In Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            // 5. Handle Network/Parsing Errors
            console.error('Login network or API call failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the login service.'}`, 'error');
        } finally {
            // 6. Reset button state
            loginBtn.textContent = 'Sign In';
            loginBtn.disabled = false;
        }
    }

    /**
     * Handles create account form submission and transitions to verification view.
     */
    async function handleCreateAccount(event) {
        event.preventDefault();
        const form = event.target;
        const email = document.getElementById('create-email').value;
        const password = document.getElementById('create-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const createBtn = document.getElementById('create-btn');

        if (password !== confirmPassword) {
            displayMessage('Passwords do not match.', 'error');
            return;
        }
        if (password.length < 8) {
            displayMessage('Password must be at least 8 characters.', 'error');
            return;
        }

        createBtn.textContent = 'Creating...';
        createBtn.disabled = true;
        displayMessage('Attempting to create account via /api/register...', 'info');

        try {
            const response = await fetch(REGISTER_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName: form.firstName.value,
                    lastName: form.lastName.value,
                    email: email,
                    password: password
                })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                    // Throwing an error here prevents the "Unexpected end of JSON input" error on 404/500
                    throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                // Success: Account created, verification code sent
                pendingVerificationEmail = email;
                document.getElementById('verify-email-display').textContent = email;
                
                displayMessage(`Success! Account created. Now check ${email} for your 6-digit verification code.`, 'success');
                
                form.reset();

                setTimeout(() => {
                    showView('verify');
                    setResendCooldown(60); 
                }, 2000); 

            } else {
                // Handle API errors (4xx, 5xx with JSON body)
                const errorMessage = data.message || `API Error (${response.status}): An unexpected error occurred.`;
                displayMessage(`Registration Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            // Handle network errors or the Error thrown by robust parsing
            console.error('Network or API call failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the registration service. Check endpoint configuration.'}`, 'error');
        } finally {
            createBtn.textContent = 'Create Account';
            createBtn.disabled = false;
        }
    }

    /**
     * Handles account verification code submission.
     */
    async function handleVerification(event) {
        event.preventDefault();
        const code = document.getElementById('verify-code').value;
        const verifyBtn = document.getElementById('verify-btn');
        const email = pendingVerificationEmail;
        
        if (!email) {
            displayMessage('Error: No pending email found. Please create an account.', 'error');
            showView('create');
            return;
        }

        verifyBtn.textContent = 'Verifying...';
        verifyBtn.disabled = true;
        
        try {
            const response = await fetch(VERIFY_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: code })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                    throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING


            if (response.ok) {
                displayMessage('Account verified successfully! You can now sign in.', 'success');
                
                pendingVerificationEmail = ''; 
                document.getElementById('verify-code').value = '';
                
                setTimeout(() => {
                    showView('login');
                    document.getElementById('login-email').value = email; // Pre-fill email
                }, 2000);

            } else {
                const errorMessage = data.message || `Verification API Error (${response.status}).`;
                displayMessage(`Verification Failed: ${errorMessage}`, 'error');
            }

        } catch (error) {
            console.error('Verification network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the verification service.'}`, 'error');
        } finally {
            verifyBtn.textContent = 'Verify Account';
            verifyBtn.disabled = false;
        }
    }

    /**
     * Starts a cooldown timer for the Resend Code button.
     */
    function setResendCooldown(durationSeconds = 60) {
        const resendBtn = document.getElementById('resend-btn');
        resendBtn.disabled = true;
        let timer = durationSeconds;
        resendBtn.textContent = `Resend Code (${timer}s)`;

        const interval = setInterval(() => {
            timer--;
            if (timer > 0) {
                resendBtn.textContent = `Resend Code (${timer}s)`;
            } else {
                clearInterval(interval);
                resendBtn.textContent = 'Resend Code';
                resendBtn.disabled = false;
            }
        }, 1000);
    }

    /**
     * Handles resending the verification code with cooldown logic.
     */
    async function handleResendCode() {
        const resendBtn = document.getElementById('resend-btn');
        const email = pendingVerificationEmail;

        if (resendBtn.disabled) {
            // Cooldown is active, just return
            return;
        }
        
        if (!email) {
            showView('create');
            displayMessage('Please create an account first.', 'error');
            return;
        }

        setResendCooldown(60); 
        displayMessage(`Resending code to ${email}...`, 'info');

        try {
            const response = await fetch(RESEND_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });

            // ROBUST JSON PARSING
            let data = {};
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else if (!response.ok) {
                    throw new Error(`Server Error (${response.status}): Netlify could not find the function or the server crashed.`);
            }
            // END ROBUST PARSING
            
            if (response.ok) {
                displayMessage('New code successfully sent! Check your inbox.', 'success');
            } else {
                const errorMessage = data.message || `Resend API Error (${response.status}).`;
                displayMessage(`Resend Failed: ${errorMessage}`, 'error');
            }
        } catch (error) {
            console.error('Resend network failed:', error);
            displayMessage(`Connection Error: ${error.message || 'Could not connect to the resend service.'}`, 'error');
        }
    }

    /**
     * Placeholder function for handling forgot password form submission.
     */
    function handleForgotPassword(event) {
        event.preventDefault();
        const email = document.getElementById('forgot-email').value;
        // In a real app, send API call to trigger password reset email
        displayMessage(`If an account exists for ${email}, a password reset link has been sent.`, 'success');
        setTimeout(() => {
            showView('login');
        }, 5000);
    }

    // --- Event Listeners and Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize DOM elements after load
        views = {
            'login': document.getElementById('login-view'),
            'create': document.getElementById('create-view'),
            'verify': document.getElementById('verify-view'),
            'forgot': document.getElementById('forgot-view'),
        };
        headerElement = document.getElementById('auth-header');
        messageArea = document.getElementById('message-area'); // ðŸ‘ˆ FIX: Ensure this points to the new HTML element
        container = document.getElementById('auth-views');

        // Attach form submission handlers
        document.getElementById('login-form').addEventListener('submit', handleSignIn);
        document.getElementById('create-form').addEventListener('submit', handleCreateAccount);
        document.getElementById('verify-form').addEventListener('submit', handleVerification);
        document.getElementById('forgot-form').addEventListener('submit', handleForgotPassword);
        
        // Show the initial view
        showView('login');
    });

    
</script>
</body>
</html>